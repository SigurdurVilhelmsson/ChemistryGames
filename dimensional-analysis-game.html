<!DOCTYPE html>
<html lang="is">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Einingagreining - N√°mslei√∞in</title>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');

        body {
            font-family: 'Inter', sans-serif;
        }

        .primary-orange {
            color: #f36b22;
        }

        .bg-primary-orange {
            background-color: #f36b22;
        }

        .bg-dark-orange {
            background-color: #d95a1a;
        }

        .border-primary-orange {
            border-color: #f36b22;
        }

        .hover-orange:hover {
            background-color: #f36b22;
        }

        .animate-fill {
            animation: fillUp 2s ease-in-out;
        }

        @keyframes fillUp {
            from { height: 0%; }
            to { height: 100%; }
        }

        .cancel-animation {
            animation: cancelOut 0.5s ease-out;
        }

        @keyframes cancelOut {
            0% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.5; transform: scale(1.2); }
            100% { opacity: 0; transform: scale(0); }
        }
    </style>
</head>
<body class="bg-gray-50">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useCallback } = React;

        // ==================== DATA BANKS ====================

        const lessons = [
            {
                id: 1,
                title: "Hva√∞ er umbreytingarstu√∞ull?",
                content: "Umbreytingarstu√∞ull er brot sem jafngildir 1. Vegna √æess a√∞ teljari og nefnari t√°kna sama magn, getum vi√∞ margfalda√∞ me√∞ honum √°n √æess a√∞ breyta raunverulegu magni.",
                animation: "beakers",
                quiz: {
                    question: "Hva√∞a gildi hefur 1000 mL / 1 L?",
                    options: ["0.001", "1", "1000", "1000000"],
                    correct: 1,
                    explanation: "Vegna √æess a√∞ 1000 mL = 1 L √æ√° er √æessi brot jafn og 1"
                }
            },
            {
                id: 2,
                title: "Af hverju strikast einingar √∫t?",
                content: "√ûegar sama einingin birtist b√¶√∞i √≠ teljara og nefnara getum vi√∞ strika√∞ hana √∫t, alveg eins og me√∞ t√∂lur √≠ brotum.",
                animation: "cancellation",
                quiz: {
                    question: "Hva√∞a p√∂r strikast √∫t? (Veldu √∂ll r√©tt)",
                    options: ["g/g", "mL/L", "kg/g", "cm/cm"],
                    correct: [0, 3],
                    multiSelect: true,
                    explanation: "A√∞eins n√°kv√¶mlega sama einingin strikast √∫t: g me√∞ g, cm me√∞ cm"
                }
            },
            {
                id: 3,
                title: "Hvernig vel √©g r√©tta stefnu?",
                content: "Til a√∞ velja r√©tta stefnu √° umbreytingarstu√∞li √æarftu a√∞ hugsa um hva√∞a eining √æarf a√∞ vera √≠ nefnara til a√∞ strikast √∫t vi√∞ upphafseiningu.",
                animation: "orientation",
                quiz: {
                    question: "Til a√∞ breyta g ‚Üí kg, hva√∞a stu√∞ull er r√©ttur?",
                    options: ["1 kg / 1000 g", "1000 g / 1 kg", "B√°√∞ir virka", "Hvorugur virkar"],
                    correct: 0,
                    explanation: "Vi√∞ √æurfum 'g' √≠ nefnara til a√∞ strika √∫t vi√∞ upphafs 'g', svo 1 kg / 1000 g er r√©tt"
                }
            }
        ];

        const level1Questions = [
            {
                id: 'L1-1',
                type: 'equivalence',
                prompt: 'Hva√∞ af √æessu jafngildir 1? (Veldu √∂ll r√©tt)',
                options: [
                    { text: '1000 mL / 1 L', correct: true },
                    { text: '1000 g / 1 kg', correct: true },
                    { text: '100 mL / 1 L', correct: false },
                    { text: '60 s / 1 m√≠n', correct: true },
                    { text: '50 cm / 1 m', correct: false }
                ],
                multiSelect: true,
                explanationRequired: false,
                hint: 'Umbreytingarstu√∞ull jafngildir 1 √æegar teljari og nefnari t√°kna sama magn. T.d. 1000 mL = 1 L, svo 1000 mL / 1 L = 1.',
                points: 8
            },
            {
                id: 'L1-2',
                type: 'cancellation_prediction',
                prompt: 'Ef √æ√∫ byrjar me√∞ 2000 g og margfaldar me√∞ (1 kg / 1000 g), hva√∞ ver√∞ur eftir?',
                options: ['g', 'kg', 'g¬∑kg', 'g/kg'],
                correct: 1,
                explanationRequired: true,
                explanationOptions: [
                    { text: 'Vegna √æess a√∞ g strikast √∫t og kg ver√∞ur eftir', correct: true },
                    { text: 'Vegna √æess a√∞ kg er st√¶rra', correct: false },
                    { text: 'Vegna √æess a√∞ talan minnkar', correct: false }
                ],
                hint: '√ûegar g er b√¶√∞i √≠ upphafsgildinu og √≠ nefnara stu√∞ulsins, strikast g √∫t. √ûa√∞ sem eftir er kemur √∫r teljara stu√∞ulsins.',
                points: 8
            },
            {
                id: 'L1-3',
                type: 'factor_selection',
                prompt: '√û√∫ √æarft a√∞ breyta √∫r mL √≠ L. Hva√∞a stu√∞ul velur √æ√∫?',
                factors: [
                    { text: '1000 mL / 1 L', correct: false },
                    { text: '1 L / 1000 mL', correct: true }
                ],
                explanationOptions: [
                    { text: 'Vegna √æess a√∞ mL √æarf a√∞ vera √≠ nefnara til a√∞ strikast √∫t', correct: true },
                    { text: 'Vegna √æess a√∞ L er st√¶rri eining', correct: false },
                    { text: 'Vegna √æess a√∞ √æetta er einfaldara', correct: false }
                ],
                hint: 'Upphafseiningin (mL) √æarf a√∞ vera √≠ nefnara stu√∞ulsins til a√∞ strikast √∫t vi√∞ upphafsgildi√∞.',
                points: 8
            },
            {
                id: 'L1-4',
                type: 'error_identification',
                prompt: 'Anna reyndi a√∞ breyta 5000 mg √≠ g. H√∫n nota√∞i (1000 mg / 1 g). Hva√∞ f√≥r √∫rskei√∞is?',
                options: [
                    'H√∫n nota√∞i rangan stu√∞ul',
                    'Stu√∞ullinn er r√©tt sn√∫inn',
                    'H√∫n √æurfti fleiri stu√∞la',
                    'Ekkert f√≥r √∫rskei√∞is'
                ],
                correct: 1,
                correctText: 'Stu√∞ullinn er rangur sn√∫inn - mg √æarf a√∞ vera √≠ nefnara',
                visualization: '√ötkoman yr√∞i 5000000 mg¬≤/g √≠ sta√∞ 5 g',
                hint: 'Sko√∞a√∞u hvar mg einingin er √≠ stu√∞linum. Strikast h√∫n √∫t vi√∞ upphafs mg?',
                points: 8
            },
            {
                id: 'L1-5',
                type: 'conceptual',
                prompt: 'Af hverju breytist talan √æegar vi√∞ breytum einingum, √æ√≥ magn efnisins s√© √æa√∞ sama?',
                options: [
                    'Vegna √æess a√∞ mismunandi einingar m√¶la mismunandi magn',
                    'Vegna √æess a√∞ einingar af mismunandi st√¶r√∞ √æurfa mismunandi fj√∂lda til a√∞ t√°kna sama magn',
                    'Vegna √æess a√∞ umbreyting breytir efninu',
                    'Talan breytist ekki'
                ],
                correct: 1,
                hint: 'Hugsa√∞u um a√∞ m√¶la s√∂mu fjarl√¶g√∞ √≠ sent√≠metrum og metrum. √ûarftu fleiri sentimetra e√∞a fleiri metra?',
                points: 8
            },
            {
                id: 'L1-6',
                type: 'equivalence',
                prompt: 'Hva√∞ af √æessu jafngildir 1? (Veldu √∂ll r√©tt)',
                options: [
                    { text: '100 cm / 1 m', correct: true },
                    { text: '1 km / 100 m', correct: false },
                    { text: '1000 mm / 1 m', correct: true },
                    { text: '24 klst / 1 dagur', correct: true },
                    { text: '100 g / 1 kg', correct: false }
                ],
                multiSelect: true,
                hint: 'Athuga√∞u hvort teljari og nefnari t√°kna sama magn. T.d. 100 cm = 1 m, en 100 g ‚â† 1 kg.',
                points: 8
            },
            {
                id: 'L1-7',
                type: 'cancellation_prediction',
                prompt: 'Ef √æ√∫ byrjar me√∞ 500 mL og margfaldar me√∞ (1 L / 1000 mL), hva√∞ ver√∞ur eftir?',
                options: ['mL', 'L', 'mL¬∑L', 'mL/L'],
                correct: 1,
                explanationRequired: true,
                explanationOptions: [
                    { text: 'Vegna √æess a√∞ mL strikast √∫t og L ver√∞ur eftir', correct: true },
                    { text: 'Vegna √æess a√∞ vi√∞ deildum me√∞ 1000', correct: false },
                    { text: 'Vegna √æess a√∞ L er √≠ teljaranum', correct: false }
                ],
                hint: 'mL √≠ upphafsgildinu strikast √∫t vi√∞ mL √≠ nefnara. Hva√∞ ver√∞ur eftir √≠ teljara?',
                points: 8
            },
            {
                id: 'L1-8',
                type: 'factor_selection',
                prompt: '√û√∫ √æarft a√∞ breyta √∫r km √≠ m. Hva√∞a stu√∞ul velur √æ√∫?',
                factors: [
                    { text: '1 km / 1000 m', correct: false },
                    { text: '1000 m / 1 km', correct: true }
                ],
                explanationOptions: [
                    { text: 'Vegna √æess a√∞ km √æarf a√∞ vera √≠ nefnara til a√∞ strikast √∫t', correct: true },
                    { text: 'Vegna √æess a√∞ 1000 er st√¶rri tala', correct: false },
                    { text: 'Vegna √æess a√∞ m er minni eining', correct: false }
                ],
                hint: '√û√∫ ert a√∞ byrja me√∞ km. Hvar √æarf km a√∞ vera √≠ stu√∞linum til a√∞ strikast √∫t?',
                points: 8
            },
            {
                id: 'L1-9',
                type: 'error_identification',
                prompt: 'J√≥n reyndi a√∞ breyta 2 L √≠ mL. Hann nota√∞i (1 L / 1000 mL). Hva√∞ f√≥r √∫rskei√∞is?',
                options: [
                    'Hann nota√∞i rangan stu√∞ul',
                    'Stu√∞ullinn er rangur sn√∫inn',
                    'Hann √æurfti fleiri stu√∞la',
                    'Ekkert f√≥r √∫rskei√∞is'
                ],
                correct: 1,
                correctText: 'Stu√∞ullinn er rangur sn√∫inn - L √æarf a√∞ vera √≠ nefnara',
                visualization: '√ötkoman yr√∞i 0.002 L¬≤/mL √≠ sta√∞ 2000 mL',
                hint: 'L er upphafseiningin. Strikast L √∫t √≠ √æessari uppsetningu stu√∞ulsins?',
                points: 8
            },
            {
                id: 'L1-10',
                type: 'conceptual',
                prompt: 'Hva√∞ gerir umbreytingarstu√∞ul svo gagnlegan?',
                options: [
                    'Hann breytir magninu',
                    'Hann jafngildir 1 svo a√∞ margf√∂ldun breytir ekki raunverulegu magni',
                    'Hann gerir t√∂lurnar st√¶rri',
                    'Hann ey√∞ir einingunum'
                ],
                correct: 1,
                hint: 'Hva√∞ gerist √æegar √æ√∫ margfaldar me√∞ 1? Breytist gildi√∞?',
                points: 8
            }
        ];

        const conversionFactors = [
            { num: '1 kg', den: '1000 g', units: ['kg', 'g'] },
            { num: '1000 g', den: '1 kg', units: ['g', 'kg'] },
            { num: '1 g', den: '1000 mg', units: ['g', 'mg'] },
            { num: '1000 mg', den: '1 g', units: ['mg', 'g'] },
            { num: '1 L', den: '1000 mL', units: ['L', 'mL'] },
            { num: '1000 mL', den: '1 L', units: ['mL', 'L'] },
            { num: '1 km', den: '1000 m', units: ['km', 'm'] },
            { num: '1000 m', den: '1 km', units: ['m', 'km'] },
            { num: '1 m', den: '100 cm', units: ['m', 'cm'] },
            { num: '100 cm', den: '1 m', units: ['cm', 'm'] },
            { num: '1 m', den: '1000 mm', units: ['m', 'mm'] },
            { num: '1000 mm', den: '1 m', units: ['mm', 'm'] },
            { num: '1 klst', den: '3600 s', units: ['klst', 's'] },
            { num: '3600 s', den: '1 klst', units: ['s', 'klst'] },
            { num: '1 klst', den: '60 m√≠n', units: ['klst', 'm√≠n'] },
            { num: '60 m√≠n', den: '1 klst', units: ['m√≠n', 'klst'] },
            { num: '1 m√≠n', den: '60 s', units: ['m√≠n', 's'] },
            { num: '60 s', den: '1 m√≠n', units: ['s', 'm√≠n'] }
        ];

        const level2Problems = [
            {
                id: 'L2-1',
                difficulty: 'scaffolded_high',
                context: 'Lyfjagj√∂f er 500 mg. Umb√∫√∞irnar s√Ωna styrk √≠ g.',
                startValue: 500,
                startUnit: 'mg',
                targetUnit: 'g',
                correctPath: ['1 g / 1000 mg'],
                scaffoldingLevel: 3
            },
            {
                id: 'L2-2',
                difficulty: 'scaffolded_high',
                context: 'Breyttu r√∫mm√°li √∫r mL √≠ L.',
                startValue: 2500,
                startUnit: 'mL',
                targetUnit: 'L',
                correctPath: ['1 L / 1000 mL'],
                scaffoldingLevel: 3
            },
            {
                id: 'L2-3',
                difficulty: 'scaffolded_high',
                context: 'Breyttu massa √∫r g √≠ kg.',
                startValue: 3500,
                startUnit: 'g',
                targetUnit: 'kg',
                correctPath: ['1 kg / 1000 g'],
                scaffoldingLevel: 3
            },
            {
                id: 'L2-4',
                difficulty: 'scaffolded_high',
                context: 'Breyttu lengd √∫r cm √≠ m.',
                startValue: 250,
                startUnit: 'cm',
                targetUnit: 'm',
                correctPath: ['1 m / 100 cm'],
                scaffoldingLevel: 3
            },
            {
                id: 'L2-5',
                difficulty: 'scaffolded_high',
                context: 'Breyttu massa √∫r kg √≠ g.',
                startValue: 2.5,
                startUnit: 'kg',
                targetUnit: 'g',
                correctPath: ['1000 g / 1 kg'],
                scaffoldingLevel: 3
            },
            {
                id: 'L2-6',
                difficulty: 'medium',
                context: 'Breyttu lengd √∫r km √≠ cm.',
                startValue: 0.5,
                startUnit: 'km',
                targetUnit: 'cm',
                correctPath: ['1000 m / 1 km', '100 cm / 1 m'],
                scaffoldingLevel: 2
            },
            {
                id: 'L2-7',
                difficulty: 'medium',
                context: 'Breyttu massa √∫r mg √≠ kg.',
                startValue: 5000,
                startUnit: 'mg',
                targetUnit: 'kg',
                correctPath: ['1 g / 1000 mg', '1 kg / 1000 g'],
                scaffoldingLevel: 2
            },
            {
                id: 'L2-8',
                difficulty: 'medium',
                context: 'Breyttu hra√∞a √∫r km/klst √≠ m/s.',
                startValue: 90,
                startUnit: 'km/klst',
                targetUnit: 'm/s',
                correctPath: ['1000 m / 1 km', '1 klst / 3600 s'],
                scaffoldingLevel: 2
            },
            {
                id: 'L2-9',
                difficulty: 'medium',
                context: 'Breyttu t√≠ma √∫r klst √≠ s.',
                startValue: 2,
                startUnit: 'klst',
                targetUnit: 's',
                correctPath: ['3600 s / 1 klst'],
                scaffoldingLevel: 2
            },
            {
                id: 'L2-10',
                difficulty: 'medium',
                context: 'Breyttu lengd √∫r mm √≠ km.',
                startValue: 5000000,
                startUnit: 'mm',
                targetUnit: 'km',
                correctPath: ['1 m / 1000 mm', '1 km / 1000 m'],
                scaffoldingLevel: 2
            },
            {
                id: 'L2-11',
                difficulty: 'advanced',
                context: 'Breyttu hra√∞a √∫r m/s √≠ km/klst.',
                startValue: 25,
                startUnit: 'm/s',
                targetUnit: 'km/klst',
                correctPath: ['1 km / 1000 m', '3600 s / 1 klst'],
                scaffoldingLevel: 1
            },
            {
                id: 'L2-12',
                difficulty: 'advanced',
                context: 'Breyttu lengd √∫r cm √≠ km.',
                startValue: 150000,
                startUnit: 'cm',
                targetUnit: 'km',
                correctPath: ['1 m / 100 cm', '1 km / 1000 m'],
                scaffoldingLevel: 1
            },
            {
                id: 'L2-13',
                difficulty: 'advanced',
                context: 'Breyttu r√∫mm√°l √∫r mL √≠ L og s√≠√∞an aftur √≠ mL me√∞ √∂√∞ru gildi.',
                startValue: 500,
                startUnit: 'mL',
                targetUnit: 'L',
                correctPath: ['1 L / 1000 mL'],
                scaffoldingLevel: 1
            },
            {
                id: 'L2-14',
                difficulty: 'advanced',
                context: 'Breyttu t√≠ma √∫r s √≠ klst.',
                startValue: 7200,
                startUnit: 's',
                targetUnit: 'klst',
                correctPath: ['1 klst / 3600 s'],
                scaffoldingLevel: 1
            },
            {
                id: 'L2-15',
                difficulty: 'advanced',
                context: 'Breyttu e√∞lismassa √∫r g/mL √≠ kg/L.',
                startValue: 1.5,
                startUnit: 'g/mL',
                targetUnit: 'kg/L',
                correctPath: ['1 kg / 1000 g', '1000 mL / 1 L'],
                scaffoldingLevel: 1
            },
            {
                id: 'L2-16',
                difficulty: 'expert',
                context: 'Frj√°ls √¶fing: Breyttu lengd √∫r mm √≠ m.',
                startValue: 2500,
                startUnit: 'mm',
                targetUnit: 'm',
                correctPath: ['1 m / 1000 mm'],
                scaffoldingLevel: 0
            },
            {
                id: 'L2-17',
                difficulty: 'expert',
                context: 'Frj√°ls √¶fing: Breyttu massa √∫r mg √≠ g.',
                startValue: 750,
                startUnit: 'mg',
                targetUnit: 'g',
                correctPath: ['1 g / 1000 mg'],
                scaffoldingLevel: 0
            },
            {
                id: 'L2-18',
                difficulty: 'expert',
                context: 'Frj√°ls √¶fing: Breyttu hra√∞a √∫r m/s √≠ km/klst.',
                startValue: 15,
                startUnit: 'm/s',
                targetUnit: 'km/klst',
                correctPath: ['1 km / 1000 m', '3600 s / 1 klst'],
                scaffoldingLevel: 0
            }
        ];

        const level3Challenges = [
            {
                id: 'L3-1',
                type: 'reverse',
                prompt: 'Nemandi byrja√∞i me√∞ 5000 mg og enda√∞i me√∞ 0.005 kg. Hva√∞a umbreytingarstu√∞la nota√∞i hann l√≠klega?',
                setup: { start: '5000 mg', end: '0.005 kg', startValue: 5000, endValue: 0.005 },
                options: [
                    {
                        text: '1 g / 1000 mg, s√≠√∞an 1 kg / 1000 g',
                        factors: ['1 g / 1000 mg', '1 kg / 1000 g'],
                        correct: true,
                        steps: 2
                    },
                    {
                        text: '1 kg / 1000000 mg',
                        factors: ['1 kg / 1000000 mg'],
                        correct: true,
                        steps: 1
                    },
                    {
                        text: '1000 g / 1 kg, s√≠√∞an 1000 mg / 1 g',
                        factors: ['1000 g / 1 kg', '1000 mg / 1 g'],
                        correct: false,
                        steps: 2
                    }
                ],
                explanationPrompt: '√ötsk√Ωr√∞u hvernig umbreytingin virkar:'
            },
            {
                id: 'L3-2',
                type: 'error_analysis',
                prompt: 'Mar√≠a reyndi a√∞ breyta 250 mL √≠ L. H√∫n f√©kk 250000 L. Hva√∞ f√≥r √∫rskei√∞is og hva√∞ er r√©tta svari√∞?',
                incorrectWork: '250 mL √ó (1000 mL / 1 L) = 250000 L',
                correctAnswer: 0.25,
                correctUnit: 'L',
                errorExplanation: 'Mar√≠a nota√∞i stu√∞ulinn √∂fugan - h√∫n margfalda√∞i me√∞ mL √≠ sta√∞ √æess a√∞ deila',
                correctMethod: ['1 L / 1000 mL']
            },
            {
                id: 'L3-3',
                type: 'efficiency',
                prompt: 'Breyttu 0.000005 km √≠ mm. Finndu skilvirkustu lei√∞ina (f√¶st skref).',
                startValue: 0.000005,
                startUnit: 'km',
                targetUnit: 'mm',
                possiblePaths: [
                    { steps: ['1000 m / 1 km', '1000 mm / 1 m'], stepCount: 2, efficient: true },
                    { steps: ['1000 m / 1 km', '100 cm / 1 m', '10 mm / 1 cm'], stepCount: 3, efficient: false },
                    { steps: ['100000 cm / 1 km', '10 mm / 1 cm'], stepCount: 2, efficient: true }
                ],
                targetAnswer: 5
            },
            {
                id: 'L3-4',
                type: 'synthesis',
                prompt: '√û√∫ m√¶lir 50.0 mL af lausn me√∞ e√∞lismassa 2.50 g/mL. Hversu m√∂rg kg er √æetta? Gef√∞u svar √≠ 3 markver√∞um t√∂lust√∂fum.',
                startValue: 50.0,
                startUnit: 'mL',
                density: 2.50,
                densityUnit: 'g/mL',
                targetUnit: 'kg',
                expectedAnswer: 0.125,
                significantFigures: 3,
                requiredSteps: ['multiply by density', 'convert g to kg']
            },
            {
                id: 'L3-5',
                type: 'real_world',
                prompt: '√û√∫ √°tt 2.0 L af stofnlausn og √æarft a√∞ √∫tb√∫a 150 mL skammta. Hversu marga skammta getur √æ√∫ √∫tb√∫i√∞?',
                startValue: 2.0,
                startUnit: 'L',
                portionSize: 150,
                portionUnit: 'mL',
                expectedAnswer: 13,
                requireInteger: true,
                explanation: 'Svar ver√∞ur a√∞ vera heiltala vegna √æess a√∞ ekki er h√¶gt a√∞ √∫tb√∫a hluta af skammti'
            },
            {
                id: 'L3-6',
                type: 'derivation',
                prompt: 'Hra√∞i lj√≥ss er 3.00 √ó 10‚Å∏ m/s. Birtu svari√∞ √≠ km/klst.',
                startValue: 3.00e8,
                startUnit: 'm/s',
                targetUnit: 'km/klst',
                expectedAnswer: 1.08e12,
                scientificNotation: true,
                correctMethod: ['1 km / 1000 m', '3600 s / 1 klst']
            },
            {
                id: 'L3-7',
                type: 'reverse',
                prompt: 'Nemandi byrja√∞i me√∞ 72 km/klst og enda√∞i me√∞ 20 m/s. Hva√∞a stu√∞la nota√∞i hann?',
                setup: { start: '72 km/klst', end: '20 m/s', startValue: 72, endValue: 20 },
                options: [
                    {
                        text: '1000 m / 1 km, s√≠√∞an 1 klst / 3600 s',
                        factors: ['1000 m / 1 km', '1 klst / 3600 s'],
                        correct: true,
                        steps: 2
                    },
                    {
                        text: '1 km / 1000 m, s√≠√∞an 3600 s / 1 klst',
                        factors: ['1 km / 1000 m', '3600 s / 1 klst'],
                        correct: false,
                        steps: 2
                    }
                ],
                explanationPrompt: '√ötsk√Ωr√∞u umbreytinguna:'
            },
            {
                id: 'L3-8',
                type: 'synthesis',
                prompt: 'E√∞lismassi kopar er 8.96 g/cm¬≥. Breyttu √æessu √≠ kg/m¬≥.',
                startValue: 8.96,
                startUnit: 'g/cm¬≥',
                targetUnit: 'kg/m¬≥',
                expectedAnswer: 8960,
                significantFigures: 3,
                requiredSteps: ['convert g to kg', 'convert cm¬≥ to m¬≥']
            },
            {
                id: 'L3-9',
                type: 'error_analysis',
                prompt: 'J√≥n reyndi a√∞ breyta 3 klst √≠ sek√∫ndur. Hann f√©kk 180 s. Hva√∞ f√≥r √∫rskei√∞is?',
                incorrectWork: '3 klst √ó (60 m√≠n / 1 klst) = 180',
                correctAnswer: 10800,
                correctUnit: 's',
                errorExplanation: 'J√≥n gleymdi a√∞ breyta m√≠n√∫tum √≠ sek√∫ndur',
                correctMethod: ['60 m√≠n / 1 klst', '60 s / 1 m√≠n']
            },
            {
                id: 'L3-10',
                type: 'efficiency',
                prompt: 'Breyttu 500000 mg √≠ kg. Veldu skilvirkustu lei√∞ina.',
                startValue: 500000,
                startUnit: 'mg',
                targetUnit: 'kg',
                possiblePaths: [
                    { steps: ['1 g / 1000 mg', '1 kg / 1000 g'], stepCount: 2, efficient: true },
                    { steps: ['1 kg / 1000000 mg'], stepCount: 1, efficient: true },
                    { steps: ['1000 g / 1 kg'], stepCount: 1, efficient: false }
                ],
                targetAnswer: 0.5
            }
        ];

        // ==================== UTILITY FUNCTIONS ====================

        const saveProgress = (gameState) => {
            localStorage.setItem('dimensionalAnalysisProgress', JSON.stringify(gameState));
        };

        const loadProgress = () => {
            const saved = localStorage.getItem('dimensionalAnalysisProgress');
            if (saved) {
                return JSON.parse(saved);
            }
            return null;
        };

        const checkLevel1Mastery = (level1Data) => {
            const { questionsCorrect, questionsAnswered, explanationScores, pointsEarned } = level1Data;
            if (questionsAnswered < 10) return false;

            const avgExplanation = explanationScores.length > 0
                ? explanationScores.reduce((a, b) => a + b, 0) / explanationScores.length
                : 1;

            // Require 64+ points (80%) AND 8/10 correct with explanations
            return (pointsEarned || 0) >= 64 && questionsCorrect >= 8 && avgExplanation >= 0.7;
        };

        const checkLevel2Mastery = (level2Data) => {
            const { problemsCompleted, predictionsMade, predictionsCorrect, finalAnswersCorrect } = level2Data;
            if (problemsCompleted < 15) return false;

            const predictionAccuracy = predictionsMade > 0 ? predictionsCorrect / predictionsMade : 0;
            const answerAccuracy = problemsCompleted > 0 ? finalAnswersCorrect / problemsCompleted : 0;

            return predictionAccuracy >= 0.7 && answerAccuracy >= 0.8;
        };

        const checkLevel3Mastery = (level3Data) => {
            const { compositeScores } = level3Data;
            if (compositeScores.length < 10) return false;

            const avgScore = compositeScores.reduce((a, b) => a + b, 0) / compositeScores.length;
            return avgScore >= 0.75;
        };

        const calculateCompositeScore = (answerScore, methodScore, explanationScore, efficiencyScore = 0) => {
            // Weighted composite: answer 40%, method 30%, explanation 20%, efficiency 10%
            return (answerScore * 0.4) + (methodScore * 0.3) + (explanationScore * 0.2) + (efficiencyScore * 0.1);
        };

        const checkAchievements = (level3Data) => {
            const achievements = [];
            const { compositeScores, problemsCompleted, totalSteps } = level3Data;

            if (compositeScores.length >= 10) {
                const avgScore = compositeScores.reduce((a, b) => a + b, 0) / compositeScores.length;

                if (avgScore >= 0.95) {
                    achievements.push({ id: 'gold', name: 'Gullstjarna', description: '95%+ heildareinkunn' });
                } else if (avgScore >= 0.85) {
                    achievements.push({ id: 'silver', name: 'Silfurstjarna', description: '85%+ heildareinkunn' });
                } else if (avgScore >= 0.75) {
                    achievements.push({ id: 'bronze', name: 'Bronsstjarna', description: '75%+ heildareinkunn' });
                }

                const avgSteps = totalSteps / problemsCompleted;
                if (avgSteps < 3) {
                    achievements.push({ id: 'efficiency', name: 'Skilvirkni', description: 'A√∞ me√∞altali f√¶rri en 3 skref' });
                }

                const perfectExplanations = compositeScores.every(score => score >= 0.9);
                if (perfectExplanations) {
                    achievements.push({ id: 'explainer', name: '√ötsk√Ωrandi', description: 'Fullkomnar √∫tsk√Ωringar' });
                }
            }

            return achievements;
        };

        const parseUnit = (unitString) => {
            // Parse compound units like "km/klst" or simple units like "g"
            if (unitString.includes('/')) {
                const [num, den] = unitString.split('/');
                return { numerator: num.trim(), denominator: den.trim() };
            }
            return { numerator: unitString.trim(), denominator: null };
        };

        const predictResultingUnit = (currentUnit, factor) => {
            // Predict what unit will result from applying a factor
            const current = parseUnit(currentUnit);
            const factorParsed = { numerator: factor.num.split(' ')[1], denominator: factor.den.split(' ')[1] };

            if (!current.denominator) {
                // Simple unit
                if (current.numerator === factorParsed.denominator) {
                    return factorParsed.numerator;
                }
                return currentUnit; // No cancellation
            } else {
                // Compound unit - this is simplified for now
                let newNum = current.numerator;
                let newDen = current.denominator;

                if (current.numerator === factorParsed.denominator) {
                    newNum = factorParsed.numerator;
                }
                if (current.denominator === factorParsed.numerator) {
                    newDen = factorParsed.denominator;
                }

                return `${newNum}/${newDen}`;
            }
        };

        // ==================== COMPONENTS ====================

        function AnimationDisplay({ type }) {
            if (type === 'beakers') {
                return (
                    <div className="flex justify-center items-end gap-8 h-64 p-8">
                        <div className="text-center">
                            <div className="relative w-32 h-48 border-4 border-blue-500 rounded-b-lg bg-blue-100">
                                <div className="absolute bottom-0 w-full h-full bg-blue-400 animate-fill rounded-b-lg"></div>
                            </div>
                            <p className="mt-2 font-bold">1000 mL</p>
                        </div>
                        <div className="text-2xl font-bold self-center">=</div>
                        <div className="text-center">
                            <div className="relative w-32 h-48 border-4 border-green-500 rounded-b-lg bg-green-100">
                                <div className="absolute bottom-0 w-full h-full bg-green-400 animate-fill rounded-b-lg"></div>
                            </div>
                            <p className="mt-2 font-bold">1 L</p>
                        </div>
                    </div>
                );
            }

            if (type === 'cancellation') {
                return (
                    <div className="flex flex-col items-center justify-center h-64 p-8">
                        <div className="text-4xl mb-8">
                            <span className="inline-block relative">
                                <span className="text-red-600 font-bold">g</span>
                                <span className="absolute top-1/2 left-0 w-full h-0.5 bg-red-600"></span>
                            </span>
                            <span className="mx-2">/</span>
                            <span className="inline-block relative">
                                <span className="text-red-600 font-bold">g</span>
                                <span className="absolute top-1/2 left-0 w-full h-0.5 bg-red-600"></span>
                            </span>
                            <span className="mx-4">=</span>
                            <span className="font-bold text-green-600">1</span>
                        </div>
                        <p className="text-lg text-gray-700">Sama einingin strikast √∫t!</p>
                    </div>
                );
            }

            if (type === 'orientation') {
                return (
                    <div className="flex flex-col items-center justify-center h-64 p-8 space-y-4">
                        <div className="text-2xl">
                            500 <span className="text-blue-600 font-bold">g</span>
                            <span className="mx-2">√ó</span>
                            <span className="border-2 border-green-500 px-3 py-1 rounded">
                                1 kg / 1000 <span className="text-blue-600 font-bold">g</span>
                            </span>
                        </div>
                        <div className="text-xl text-green-600">‚úì g strikast √∫t!</div>
                        <div className="h-px w-64 bg-gray-300 my-4"></div>
                        <div className="text-2xl">
                            500 <span className="text-blue-600 font-bold">g</span>
                            <span className="mx-2">√ó</span>
                            <span className="border-2 border-red-500 px-3 py-1 rounded">
                                1000 <span className="text-blue-600 font-bold">g</span> / 1 kg
                            </span>
                        </div>
                        <div className="text-xl text-red-600">‚úó g margfaldast!</div>
                    </div>
                );
            }

            return null;
        }

        function LessonScreen({ lesson, onComplete }) {
            const [quizAnswer, setQuizAnswer] = useState(null);
            const [selectedOptions, setSelectedOptions] = useState([]);
            const [showFeedback, setShowFeedback] = useState(false);

            const handleSubmit = () => {
                if (lesson.quiz.multiSelect) {
                    const correct = selectedOptions.length === lesson.quiz.correct.length &&
                        selectedOptions.every(idx => lesson.quiz.correct.includes(idx));
                    setShowFeedback(true);
                    if (correct) {
                        setTimeout(() => onComplete(), 2000);
                    }
                } else {
                    setShowFeedback(true);
                    if (quizAnswer === lesson.quiz.correct) {
                        setTimeout(() => onComplete(), 2000);
                    }
                }
            };

            const toggleOption = (idx) => {
                if (selectedOptions.includes(idx)) {
                    setSelectedOptions(selectedOptions.filter(i => i !== idx));
                } else {
                    setSelectedOptions([...selectedOptions, idx]);
                }
            };

            return (
                <div className="min-h-screen bg-gray-50 p-4">
                    <div className="max-w-4xl mx-auto">
                        <div className="bg-white rounded-lg shadow-lg p-6 mb-6">
                            <h2 className="text-2xl font-bold primary-orange mb-4">
                                Kennsla {lesson.id}/3: {lesson.title}
                            </h2>

                            <div className="mb-6">
                                <AnimationDisplay type={lesson.animation} />
                            </div>

                            <p className="text-lg text-gray-700 mb-6">{lesson.content}</p>

                            <div className="border-t pt-6">
                                <h3 className="text-xl font-semibold mb-4">{lesson.quiz.question}</h3>

                                <div className="space-y-3">
                                    {lesson.quiz.options.map((option, idx) => (
                                        <button
                                            key={idx}
                                            onClick={() => {
                                                if (lesson.quiz.multiSelect) {
                                                    toggleOption(idx);
                                                } else {
                                                    setQuizAnswer(idx);
                                                }
                                            }}
                                            className={`w-full p-4 rounded-lg border-2 text-left transition-all ${
                                                lesson.quiz.multiSelect
                                                    ? selectedOptions.includes(idx)
                                                        ? 'border-primary-orange bg-orange-50'
                                                        : 'border-gray-300 hover:border-gray-400'
                                                    : quizAnswer === idx
                                                        ? 'border-primary-orange bg-orange-50'
                                                        : 'border-gray-300 hover:border-gray-400'
                                            }`}
                                        >
                                            {option}
                                        </button>
                                    ))}
                                </div>

                                {showFeedback && (
                                    <div className={`mt-4 p-4 rounded-lg ${
                                        (lesson.quiz.multiSelect
                                            ? selectedOptions.length === lesson.quiz.correct.length &&
                                              selectedOptions.every(idx => lesson.quiz.correct.includes(idx))
                                            : quizAnswer === lesson.quiz.correct)
                                            ? 'bg-green-100 text-green-800'
                                            : 'bg-red-100 text-red-800'
                                    }`}>
                                        {(lesson.quiz.multiSelect
                                            ? selectedOptions.length === lesson.quiz.correct.length &&
                                              selectedOptions.every(idx => lesson.quiz.correct.includes(idx))
                                            : quizAnswer === lesson.quiz.correct) ? (
                                            <>
                                                <p className="font-bold">‚úì R√©tt!</p>
                                                <p>{lesson.quiz.explanation}</p>
                                            </>
                                        ) : (
                                            <p className="font-bold">‚úó Reyndu aftur</p>
                                        )}
                                    </div>
                                )}

                                <button
                                    onClick={handleSubmit}
                                    disabled={lesson.quiz.multiSelect ? selectedOptions.length === 0 : quizAnswer === null}
                                    className="mt-6 w-full bg-primary-orange text-white py-3 rounded-lg font-bold hover:bg-dark-orange disabled:bg-gray-300 disabled:cursor-not-allowed"
                                >
                                    Sta√∞festa svar
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            );
        }

        function QuestionScreen({ question, questionNumber, totalQuestions, onAnswer, onBack }) {
            const [selectedAnswer, setSelectedAnswer] = useState(null);
            const [selectedOptions, setSelectedOptions] = useState([]);
            const [selectedExplanation, setSelectedExplanation] = useState(null);
            const [showFeedback, setShowFeedback] = useState(false);
            const [isCorrect, setIsCorrect] = useState(false);
            const [showHint, setShowHint] = useState(false);
            const [hintUsed, setHintUsed] = useState(false);

            // Keyboard shortcuts
            useEffect(() => {
                const handleKeyPress = (e) => {
                    if (showFeedback) {
                        if (e.key === 'Enter') {
                            handleContinue();
                        }
                        return;
                    }

                    // Number keys to select options
                    if (e.key >= '1' && e.key <= '9') {
                        const index = parseInt(e.key) - 1;
                        if (question.multiSelect) {
                            if (index < question.options.length) {
                                toggleOption(index);
                            }
                        } else {
                            const maxOptions = question.type === 'factor_selection'
                                ? question.factors.length
                                : question.options.length;
                            if (index < maxOptions) {
                                setSelectedAnswer(index);
                            }
                        }
                    }

                    // H for hint
                    if (e.key === 'h' || e.key === 'H') {
                        if (question.hint && !showHint) {
                            handleHint();
                        }
                    }

                    // Enter to submit
                    if (e.key === 'Enter') {
                        if (canSubmit()) {
                            handleSubmit();
                        }
                    }

                    // Escape to go back
                    if (e.key === 'Escape') {
                        onBack();
                    }
                };

                window.addEventListener('keydown', handleKeyPress);
                return () => window.removeEventListener('keydown', handleKeyPress);
            }, [showFeedback, selectedAnswer, selectedOptions, selectedExplanation, showHint]);

            const handleSubmit = () => {
                let correct = false;
                let explanationCorrect = true;

                if (question.multiSelect) {
                    const correctOptions = question.options
                        .map((opt, idx) => opt.correct ? idx : -1)
                        .filter(idx => idx !== -1);
                    correct = selectedOptions.length === correctOptions.length &&
                        selectedOptions.every(idx => correctOptions.includes(idx));
                } else if (question.type === 'factor_selection') {
                    correct = question.factors[selectedAnswer]?.correct || false;
                    if (question.explanationOptions && selectedExplanation !== null) {
                        explanationCorrect = question.explanationOptions[selectedExplanation]?.correct || false;
                    }
                } else {
                    correct = selectedAnswer === question.correct;
                }

                if (question.explanationRequired && selectedExplanation !== null) {
                    explanationCorrect = question.explanationOptions[selectedExplanation]?.correct || false;
                }

                const finalCorrect = correct && explanationCorrect;
                setIsCorrect(finalCorrect);
                setShowFeedback(true);
            };

            const handleContinue = () => {
                const explanationCorrect = question.explanationRequired ? (selectedExplanation !== null && question.explanationOptions[selectedExplanation]?.correct) : true;
                onAnswer(isCorrect, explanationCorrect, hintUsed);
            };

            const handleHint = () => {
                setShowHint(true);
                setHintUsed(true);
            };

            const toggleOption = (idx) => {
                if (selectedOptions.includes(idx)) {
                    setSelectedOptions(selectedOptions.filter(i => i !== idx));
                } else {
                    setSelectedOptions([...selectedOptions, idx]);
                }
            };

            const canSubmit = () => {
                if (question.multiSelect) {
                    return selectedOptions.length > 0;
                }
                if (question.explanationRequired || question.type === 'factor_selection') {
                    return selectedAnswer !== null && selectedExplanation !== null;
                }
                return selectedAnswer !== null;
            };

            return (
                <div className="min-h-screen bg-gray-50 p-4">
                    <div className="max-w-4xl mx-auto">
                        <div className="mb-4 flex items-center justify-between">
                            <button
                                onClick={onBack}
                                className="text-gray-600 hover:text-gray-800 flex items-center gap-2"
                                aria-label="Til baka"
                            >
                                ‚Üê Til baka
                            </button>
                            <span className="text-gray-600">
                                Spurning {questionNumber} / {totalQuestions}
                            </span>
                        </div>

                        <div className="bg-white rounded-lg shadow-lg p-6">
                            <div className="flex justify-between items-start mb-6">
                                <h2 className="text-2xl font-bold flex-1">{question.prompt}</h2>
                                <div className="ml-4 text-right">
                                    <div className="text-sm font-semibold text-gray-600">
                                        Stig: <span className="text-primary-orange">{hintUsed ? 0 : question.points}</span>/{question.points}
                                    </div>
                                    {question.hint && !showFeedback && (
                                        <button
                                            onClick={handleHint}
                                            disabled={showHint}
                                            className="mt-2 text-sm bg-blue-500 hover:bg-blue-600 text-white px-3 py-1 rounded disabled:bg-gray-300 disabled:cursor-not-allowed"
                                            aria-label="S√Ωna v√≠sbendingu"
                                        >
                                            üí° V√≠sbending (H)
                                        </button>
                                    )}
                                </div>
                            </div>

                            {showHint && question.hint && (
                                <div className="mb-6 p-4 bg-yellow-50 border-l-4 border-yellow-400" role="alert">
                                    <p className="font-semibold text-yellow-800 mb-2">üí° V√≠sbending:</p>
                                    <p className="text-yellow-900">{question.hint}</p>
                                    <p className="text-sm text-yellow-700 mt-2 italic">‚ö†Ô∏è √û√∫ f√¶r√∞ 0 stig fyrir √æessa spurningu vegna √æess a√∞ √æ√∫ nota√∞ir v√≠sbendingu.</p>
                                </div>
                            )}

                            {question.type === 'error_identification' && question.visualization && (
                                <div className="mb-4 p-4 bg-yellow-50 border-l-4 border-yellow-400">
                                    <p className="text-sm text-yellow-800">{question.visualization}</p>
                                </div>
                            )}

                            <div className="space-y-3 mb-6">
                                {question.multiSelect ? (
                                    question.options.map((option, idx) => (
                                        <button
                                            key={idx}
                                            onClick={() => !showFeedback && toggleOption(idx)}
                                            disabled={showFeedback}
                                            className={`w-full p-4 rounded-lg border-2 text-left transition-all ${
                                                selectedOptions.includes(idx)
                                                    ? 'border-primary-orange bg-orange-50'
                                                    : 'border-gray-300 hover:border-gray-400'
                                            } ${showFeedback ? 'cursor-not-allowed' : ''}`}
                                        >
                                            {option.text || option}
                                        </button>
                                    ))
                                ) : question.type === 'factor_selection' ? (
                                    question.factors.map((factor, idx) => (
                                        <button
                                            key={idx}
                                            onClick={() => !showFeedback && setSelectedAnswer(idx)}
                                            disabled={showFeedback}
                                            className={`w-full p-4 rounded-lg border-2 text-left transition-all ${
                                                selectedAnswer === idx
                                                    ? 'border-primary-orange bg-orange-50'
                                                    : 'border-gray-300 hover:border-gray-400'
                                            } ${showFeedback ? 'cursor-not-allowed' : ''}`}
                                        >
                                            {factor.text}
                                        </button>
                                    ))
                                ) : (
                                    question.options.map((option, idx) => (
                                        <button
                                            key={idx}
                                            onClick={() => !showFeedback && setSelectedAnswer(idx)}
                                            disabled={showFeedback}
                                            className={`w-full p-4 rounded-lg border-2 text-left transition-all ${
                                                selectedAnswer === idx
                                                    ? 'border-primary-orange bg-orange-50'
                                                    : 'border-gray-300 hover:border-gray-400'
                                            } ${showFeedback ? 'cursor-not-allowed' : ''}`}
                                        >
                                            {option}
                                        </button>
                                    ))
                                )}
                            </div>

                            {(question.explanationRequired || question.type === 'factor_selection') && selectedAnswer !== null && (
                                <div className="mb-6 p-4 bg-blue-50 rounded-lg">
                                    <h3 className="font-semibold mb-3">Af hverju?</h3>
                                    <div className="space-y-2">
                                        {question.explanationOptions.map((exp, idx) => (
                                            <button
                                                key={idx}
                                                onClick={() => !showFeedback && setSelectedExplanation(idx)}
                                                disabled={showFeedback}
                                                className={`w-full p-3 rounded border-2 text-left text-sm transition-all ${
                                                    selectedExplanation === idx
                                                        ? 'border-blue-500 bg-blue-100'
                                                        : 'border-gray-300 hover:border-gray-400'
                                                } ${showFeedback ? 'cursor-not-allowed' : ''}`}
                                            >
                                                {exp.text}
                                            </button>
                                        ))}
                                    </div>
                                </div>
                            )}

                            {showFeedback && (
                                <div className={`mb-6 p-4 rounded-lg ${
                                    isCorrect ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'
                                }`}>
                                    <p className="font-bold text-lg mb-2">
                                        {isCorrect ? '‚úì R√©tt svar!' : '‚úó Rangt svar'}
                                    </p>
                                    {question.type === 'error_identification' && !isCorrect && question.correctText && (
                                        <p>{question.correctText}</p>
                                    )}
                                    {!isCorrect && question.explanationRequired && (
                                        <p className="mt-2">Athuga√∞u b√¶√∞i svari√∞ og √∫tsk√Ωringuna.</p>
                                    )}
                                </div>
                            )}

                            {!showFeedback ? (
                                <button
                                    onClick={handleSubmit}
                                    disabled={!canSubmit()}
                                    className="w-full bg-primary-orange text-white py-3 rounded-lg font-bold hover:bg-dark-orange disabled:bg-gray-300 disabled:cursor-not-allowed"
                                >
                                    Sta√∞festa svar
                                </button>
                            ) : (
                                <button
                                    onClick={handleContinue}
                                    className="w-full bg-primary-orange text-white py-3 rounded-lg font-bold hover:bg-dark-orange"
                                >
                                    Halda √°fram
                                </button>
                            )}
                        </div>
                    </div>
                </div>
            );
        }

        function PredictionModal({ factor, currentUnit, onPredict, onClose }) {
            const [prediction, setPrediction] = useState('');
            const [feedback, setFeedback] = useState(null);

            const handleSubmit = () => {
                const actualResult = predictResultingUnit(currentUnit, factor);
                const isCorrect = prediction.trim().toLowerCase() === actualResult.toLowerCase();

                setFeedback({
                    correct: isCorrect,
                    expected: actualResult
                });

                if (isCorrect) {
                    setTimeout(() => {
                        onPredict(true, actualResult);
                        onClose();
                    }, 1500);
                }
            };

            return (
                <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
                    <div className="bg-white rounded-lg shadow-xl max-w-md w-full p-6">
                        <h3 className="text-xl font-bold mb-4">Sp√° um ni√∞urst√∂√∞u</h3>

                        <div className="mb-4 p-4 bg-gray-50 rounded">
                            <p className="text-sm text-gray-600 mb-2">√û√∫ valdir:</p>
                            <p className="text-lg font-mono font-bold text-center">
                                {factor.num} / {factor.den}
                            </p>
                        </div>

                        <p className="mb-4">
                            Ef √æ√∫ b√¶tir √æessum stu√∞li vi√∞ <span className="font-bold">{currentUnit}</span>,
                            hva√∞a eining ver√∞ur √∫tkoman?
                        </p>

                        <input
                            type="text"
                            value={prediction}
                            onChange={(e) => setPrediction(e.target.value)}
                            placeholder="t.d. kg, m/s, L"
                            className="w-full p-3 border-2 border-gray-300 rounded-lg mb-4 font-mono"
                            autoFocus
                        />

                        {feedback && (
                            <div className={`mb-4 p-3 rounded ${
                                feedback.correct ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'
                            }`}>
                                {feedback.correct ? (
                                    <p className="font-bold">‚úì R√©tt! Einingin ver√∞ur {feedback.expected}</p>
                                ) : (
                                    <>
                                        <p className="font-bold">‚úó Rangt</p>
                                        <p className="text-sm mt-1">R√©tt svar: {feedback.expected}</p>
                                        <p className="text-sm mt-2">Reyndu aftur e√∞a veldu annan stu√∞ul.</p>
                                    </>
                                )}
                            </div>
                        )}

                        <div className="flex gap-3">
                            {!feedback?.correct && (
                                <>
                                    <button
                                        onClick={handleSubmit}
                                        disabled={!prediction.trim()}
                                        className="flex-1 bg-primary-orange text-white py-2 rounded-lg font-bold hover:bg-dark-orange disabled:bg-gray-300"
                                    >
                                        Sta√∞festa sp√°
                                    </button>
                                    <button
                                        onClick={onClose}
                                        className="px-4 border-2 border-gray-300 rounded-lg hover:border-gray-400"
                                    >
                                        H√¶tta vi√∞
                                    </button>
                                </>
                            )}
                        </div>
                    </div>
                </div>
            );
        }

        function Level3({ onComplete, onBack, initialProgress }) {
            const [currentProblemIndex, setCurrentProblemIndex] = useState(
                initialProgress?.problemsCompleted || 0
            );
            const [progress, setProgress] = useState(
                initialProgress || {
                    problemsCompleted: 0,
                    compositeScores: [],
                    totalSteps: 0,
                    achievements: [],
                    mastered: false
                }
            );
            const [userAnswer, setUserAnswer] = useState('');
            const [selectedOption, setSelectedOption] = useState(null);
            const [selectedPath, setSelectedPath] = useState(null);
            const [explanation, setExplanation] = useState('');
            const [showFeedback, setShowFeedback] = useState(false);
            // Structured explanation fields
            const [explStartUnit, setExplStartUnit] = useState('');
            const [explFirstUnit, setExplFirstUnit] = useState('');
            const [explFirstFactor, setExplFirstFactor] = useState('');
            const [explSecondUnit, setExplSecondUnit] = useState('');
            const [explSecondFactor, setExplSecondFactor] = useState('');
            const [explStepCount, setExplStepCount] = useState('');
            const [explReason, setExplReason] = useState('');
            const [scores, setScores] = useState(null);

            const problem = level3Challenges[currentProblemIndex];

            useEffect(() => {
                if (problem) {
                    setUserAnswer('');
                    setSelectedOption(null);
                    setSelectedPath(null);
                    setExplanation('');
                    setExplStartUnit('');
                    setExplFirstUnit('');
                    setExplFirstFactor('');
                    setExplSecondUnit('');
                    setExplSecondFactor('');
                    setExplStepCount('');
                    setExplReason('');
                    setShowFeedback(false);
                    setScores(null);
                }
            }, [currentProblemIndex]);

            const validateStructuredExplanation = (startUnit, firstUnit, firstFactor, secondUnit, secondFactor, stepCount, reason, problem) => {
                let score = 0;

                // Check if all required fields are filled (0.4 points)
                if (startUnit && firstUnit && firstFactor.trim() && stepCount && reason) {
                    score += 0.4;
                }

                // Check if units match problem context (0.3 points)
                if (problem.startUnit && startUnit.toLowerCase().includes(problem.startUnit.toLowerCase().replace('/', '').substring(0, 2))) {
                    score += 0.15;
                }
                if (problem.targetUnit && (secondUnit || firstUnit).toLowerCase().includes(problem.targetUnit.toLowerCase().replace('/', '').substring(0, 2))) {
                    score += 0.15;
                }

                // Check if factor contains key conversion terms (0.2 points)
                const factorLower = (firstFactor + ' ' + secondFactor).toLowerCase();
                if (factorLower.includes('1000') || factorLower.includes('100') || factorLower.includes('60') || factorLower.includes('3600')) {
                    score += 0.1;
                }
                if (factorLower.includes('/')) {
                    score += 0.1;
                }

                // Check if step count is reasonable (0.1 points)
                const steps = parseInt(stepCount);
                if (steps >= 1 && steps <= 3) {
                    score += 0.1;
                }

                return Math.min(score, 1); // Cap at 1.0
            };

            const handleSubmit = () => {
                // Build explanation from structured fields
                const builtExplanation = `√âg byrja√∞i √° ${explStartUnit} og breytti fyrst √≠ ${explFirstUnit} me√∞ stu√∞linum ${explFirstFactor}.${explSecondUnit ? ` S√≠√∞an breytti √©g √≠ ${explSecondUnit} me√∞ stu√∞linum ${explSecondFactor}.` : ''} √ûetta √æurfti ${explStepCount} skref vegna √æess a√∞ ${explReason}.`;

                let answerScore = 0;
                let methodScore = 0;
                let explanationScore = validateStructuredExplanation(explStartUnit, explFirstUnit, explFirstFactor, explSecondUnit, explSecondFactor, explStepCount, explReason, problem);
                let efficiencyScore = 0;

                // Score based on problem type
                if (problem.type === 'reverse') {
                    const selected = problem.options[selectedOption];
                    if (selected && selected.correct) {
                        answerScore = 1;
                        methodScore = 1;
                        // Efficiency bonus for fewer steps
                        if (selected.steps === 1) efficiencyScore = 1;
                        else if (selected.steps === 2) efficiencyScore = 0.8;
                    }
                } else if (problem.type === 'error_analysis') {
                    const userNum = parseFloat(userAnswer);
                    if (Math.abs(userNum - problem.correctAnswer) < 0.01) {
                        answerScore = 1;
                    }
                    if (explanation.toLowerCase().includes('√∂fug') || explanation.toLowerCase().includes('rang')) {
                        methodScore = 1;
                    }
                } else if (problem.type === 'efficiency') {
                    const userNum = parseFloat(userAnswer);
                    if (Math.abs(userNum - problem.targetAnswer) < 0.01) {
                        answerScore = 1;
                    }
                    if (selectedPath !== null) {
                        const path = problem.possiblePaths[selectedPath];
                        if (path.efficient) {
                            efficiencyScore = 1;
                            methodScore = 1;
                        } else {
                            methodScore = 0.5;
                        }
                    }
                } else if (problem.type === 'synthesis' || problem.type === 'derivation') {
                    const userNum = parseFloat(userAnswer);
                    const tolerance = problem.expectedAnswer * 0.01; // 1% tolerance
                    if (Math.abs(userNum - problem.expectedAnswer) < tolerance) {
                        answerScore = 1;
                    }
                    if (explanation.length > 20) {
                        methodScore = 1;
                    }
                } else if (problem.type === 'real_world') {
                    const userNum = parseInt(userAnswer);
                    if (userNum === problem.expectedAnswer) {
                        answerScore = 1;
                        methodScore = 1;
                    }
                }

                const composite = calculateCompositeScore(answerScore, methodScore, explanationScore, efficiencyScore);

                setScores({
                    answer: answerScore,
                    method: methodScore,
                    explanation: explanationScore,
                    efficiency: efficiencyScore,
                    composite: composite
                });

                setShowFeedback(true);

                // Update progress
                const newProgress = {
                    ...progress,
                    compositeScores: [...progress.compositeScores, composite],
                    totalSteps: progress.totalSteps + (selectedPath !== null ? problem.possiblePaths[selectedPath].stepCount : 2)
                };
                setProgress(newProgress);

                // Save progress
                const saved = loadProgress() || { levelProgress: {} };
                saved.levelProgress.level3 = newProgress;
                saveProgress(saved);
            };

            const handleContinue = () => {
                const newProgress = {
                    ...progress,
                    problemsCompleted: progress.problemsCompleted + 1
                };

                // Check mastery and achievements after 10 problems
                if (newProgress.problemsCompleted >= 10) {
                    newProgress.mastered = checkLevel3Mastery(newProgress);
                    newProgress.achievements = checkAchievements(newProgress);
                }

                setProgress(newProgress);

                const saved = loadProgress() || { levelProgress: {} };
                saved.levelProgress.level3 = newProgress;
                saveProgress(saved);

                if (currentProblemIndex < level3Challenges.length - 1) {
                    setCurrentProblemIndex(currentProblemIndex + 1);
                } else {
                    onComplete(newProgress);
                }
            };

            if (!problem) return null;

            const avgScore = progress.compositeScores.length > 0
                ? Math.round((progress.compositeScores.reduce((a, b) => a + b, 0) / progress.compositeScores.length) * 100)
                : 0;

            return (
                <div className="min-h-screen bg-gray-50 p-4">
                    <div className="max-w-4xl mx-auto">
                        <div className="mb-4 flex items-center justify-between">
                            <button
                                onClick={onBack}
                                className="text-gray-600 hover:text-gray-800 flex items-center gap-2"
                            >
                                ‚Üê Til baka
                            </button>
                            <div className="text-sm text-gray-600">
                                <span>√Åskorun {progress.problemsCompleted + 1} / 10</span>
                                <span className="ml-4">Me√∞aleinkunn: {avgScore}%</span>
                            </div>
                        </div>

                        <div className="bg-white rounded-lg shadow-lg p-6">
                            <div className="mb-4">
                                <span className="px-3 py-1 bg-purple-100 text-purple-800 rounded-full text-sm font-semibold">
                                    {problem.type === 'reverse' && '√ñfug greining'}
                                    {problem.type === 'error_analysis' && 'Villugreining'}
                                    {problem.type === 'efficiency' && 'Skilvirkni'}
                                    {problem.type === 'synthesis' && 'Samsetning'}
                                    {problem.type === 'real_world' && 'Raunveruleiki'}
                                    {problem.type === 'derivation' && 'Aflei√∞ing'}
                                </span>
                            </div>

                            <h2 className="text-2xl font-bold mb-6">{problem.prompt}</h2>

                            {problem.type === 'error_analysis' && problem.incorrectWork && (
                                <div className="mb-6 p-4 bg-red-50 border-l-4 border-red-400">
                                    <p className="text-sm text-gray-600 mb-1">R√∂ng vinna:</p>
                                    <p className="font-mono text-red-800">{problem.incorrectWork}</p>
                                </div>
                            )}

                            {!showFeedback && (
                                <div className="space-y-6">
                                    {problem.type === 'reverse' && (
                                        <div className="space-y-3">
                                            <p className="font-semibold">Veldu r√©tta lei√∞:</p>
                                            {problem.options.map((option, idx) => (
                                                <button
                                                    key={idx}
                                                    onClick={() => setSelectedOption(idx)}
                                                    className={`w-full p-4 rounded-lg border-2 text-left transition-all ${
                                                        selectedOption === idx
                                                            ? 'border-primary-orange bg-orange-50'
                                                            : 'border-gray-300 hover:border-gray-400'
                                                    }`}
                                                >
                                                    {option.text}
                                                    <span className="text-sm text-gray-500 ml-2">({option.steps} skref)</span>
                                                </button>
                                            ))}
                                        </div>
                                    )}

                                    {problem.type === 'efficiency' && (
                                        <>
                                            <div className="space-y-3">
                                                <p className="font-semibold">Veldu lei√∞:</p>
                                                {problem.possiblePaths.map((path, idx) => (
                                                    <button
                                                        key={idx}
                                                        onClick={() => setSelectedPath(idx)}
                                                        className={`w-full p-4 rounded-lg border-2 text-left transition-all ${
                                                            selectedPath === idx
                                                                ? 'border-primary-orange bg-orange-50'
                                                                : 'border-gray-300 hover:border-gray-400'
                                                        }`}
                                                    >
                                                        <div className="space-y-1">
                                                            {path.steps.map((step, sidx) => (
                                                                <div key={sidx} className="font-mono text-sm">{step}</div>
                                                            ))}
                                                        </div>
                                                        <span className="text-sm text-gray-500 mt-2 block">
                                                            {path.stepCount} skref
                                                        </span>
                                                    </button>
                                                ))}
                                            </div>
                                        </>
                                    )}

                                    <div>
                                        <label className="block font-semibold mb-2">
                                            {problem.type === 'error_analysis' ? 'Hva√∞ er r√©tta svari√∞?' : 'Svar:'}
                                        </label>
                                        <input
                                            type="text"
                                            value={userAnswer}
                                            onChange={(e) => setUserAnswer(e.target.value)}
                                            placeholder={problem.scientificNotation ? 't.d. 1.08e12' : 'Sl√°√∞u inn svar'}
                                            className="w-full p-3 border-2 border-gray-300 rounded-lg font-mono"
                                        />
                                        {problem.targetUnit && (
                                            <p className="text-sm text-gray-600 mt-1">Eining: {problem.targetUnit}</p>
                                        )}
                                    </div>

                                    <div className="bg-blue-50 p-4 rounded-lg">
                                        <label className="block font-semibold mb-3">
                                            √ötsk√Ωring (fylltu √≠ ey√∞urnar):
                                        </label>

                                        <div className="space-y-4">
                                            <div className="flex flex-wrap items-center gap-2 text-sm sm:text-base">
                                                <span>√âg byrja√∞i √°</span>
                                                <select
                                                    value={explStartUnit}
                                                    onChange={(e) => setExplStartUnit(e.target.value)}
                                                    className="p-2 border-2 border-gray-300 rounded bg-white"
                                                    aria-label="Upphafseining"
                                                >
                                                    <option value="">-- veldu --</option>
                                                    <option value="mg">mg</option>
                                                    <option value="g">g</option>
                                                    <option value="kg">kg</option>
                                                    <option value="mL">mL</option>
                                                    <option value="L">L</option>
                                                    <option value="mm">mm</option>
                                                    <option value="cm">cm</option>
                                                    <option value="m">m</option>
                                                    <option value="km">km</option>
                                                    <option value="s">s</option>
                                                    <option value="m√≠n">m√≠n</option>
                                                    <option value="klst">klst</option>
                                                    <option value="km/klst">km/klst</option>
                                                    <option value="m/s">m/s</option>
                                                    <option value="g/mL">g/mL</option>
                                                    <option value="kg/L">kg/L</option>
                                                </select>
                                            </div>

                                            <div className="flex flex-wrap items-center gap-2 text-sm sm:text-base">
                                                <span>og breytti fyrst √≠</span>
                                                <select
                                                    value={explFirstUnit}
                                                    onChange={(e) => setExplFirstUnit(e.target.value)}
                                                    className="p-2 border-2 border-gray-300 rounded bg-white"
                                                    aria-label="Fyrsta eining"
                                                >
                                                    <option value="">-- veldu --</option>
                                                    <option value="mg">mg</option>
                                                    <option value="g">g</option>
                                                    <option value="kg">kg</option>
                                                    <option value="mL">mL</option>
                                                    <option value="L">L</option>
                                                    <option value="mm">mm</option>
                                                    <option value="cm">cm</option>
                                                    <option value="m">m</option>
                                                    <option value="km">km</option>
                                                    <option value="s">s</option>
                                                    <option value="m√≠n">m√≠n</option>
                                                    <option value="klst">klst</option>
                                                    <option value="km/klst">km/klst</option>
                                                    <option value="m/s">m/s</option>
                                                    <option value="g/mL">g/mL</option>
                                                    <option value="kg/L">kg/L</option>
                                                </select>
                                            </div>

                                            <div className="flex flex-wrap items-center gap-2 text-sm sm:text-base">
                                                <span>me√∞ stu√∞linum</span>
                                                <input
                                                    type="text"
                                                    value={explFirstFactor}
                                                    onChange={(e) => setExplFirstFactor(e.target.value)}
                                                    placeholder="t.d. 1 kg / 1000 g"
                                                    className="p-2 border-2 border-gray-300 rounded bg-white flex-1 min-w-[200px]"
                                                    aria-label="Fyrsti stu√∞ull"
                                                />
                                            </div>

                                            {/* Optional second step */}
                                            <div className="border-t pt-3 space-y-3">
                                                <div className="flex flex-wrap items-center gap-2 text-sm sm:text-base">
                                                    <span>S√≠√∞an breytti √©g √≠</span>
                                                    <select
                                                        value={explSecondUnit}
                                                        onChange={(e) => setExplSecondUnit(e.target.value)}
                                                        className="p-2 border-2 border-gray-300 rounded bg-white"
                                                        aria-label="√ñnnur eining"
                                                    >
                                                        <option value="">-- veldu (ef vi√∞ √°) --</option>
                                                        <option value="mg">mg</option>
                                                        <option value="g">g</option>
                                                        <option value="kg">kg</option>
                                                        <option value="mL">mL</option>
                                                        <option value="L">L</option>
                                                        <option value="mm">mm</option>
                                                        <option value="cm">cm</option>
                                                        <option value="m">m</option>
                                                        <option value="km">km</option>
                                                        <option value="s">s</option>
                                                        <option value="m√≠n">m√≠n</option>
                                                        <option value="klst">klst</option>
                                                        <option value="km/klst">km/klst</option>
                                                        <option value="m/s">m/s</option>
                                                    </select>
                                                </div>

                                                {explSecondUnit && (
                                                    <div className="flex flex-wrap items-center gap-2 text-sm sm:text-base">
                                                        <span>me√∞ stu√∞linum</span>
                                                        <input
                                                            type="text"
                                                            value={explSecondFactor}
                                                            onChange={(e) => setExplSecondFactor(e.target.value)}
                                                            placeholder="t.d. 1 L / 1000 mL"
                                                            className="p-2 border-2 border-gray-300 rounded bg-white flex-1 min-w-[200px]"
                                                            aria-label="Annar stu√∞ull"
                                                        />
                                                    </div>
                                                )}
                                            </div>

                                            <div className="flex flex-wrap items-center gap-2 text-sm sm:text-base">
                                                <span>√ûetta √æurfti</span>
                                                <input
                                                    type="number"
                                                    value={explStepCount}
                                                    onChange={(e) => setExplStepCount(e.target.value)}
                                                    placeholder="1, 2, 3..."
                                                    className="p-2 border-2 border-gray-300 rounded bg-white w-20"
                                                    min="1"
                                                    max="10"
                                                    aria-label="Fj√∂ldi skrefa"
                                                />
                                                <span>skref vegna √æess a√∞</span>
                                            </div>

                                            <select
                                                value={explReason}
                                                onChange={(e) => setExplReason(e.target.value)}
                                                className="w-full p-2 border-2 border-gray-300 rounded bg-white"
                                                aria-label="√Åst√¶√∞a"
                                            >
                                                <option value="">-- veldu √°st√¶√∞u --</option>
                                                <option value="direct">√æa√∞ er bein umbreyting milli eininganna</option>
                                                <option value="multiple">√æurfti a√∞ fara √≠ gegnum millieiningu</option>
                                                <option value="compound">einingin er samsett (t.d. km/klst)</option>
                                                <option value="complex">√æetta er fl√≥ki√∞ vandam√°l me√∞ m√∂rgum umbreytingum</option>
                                            </select>
                                        </div>
                                    </div>

                                    <button
                                        onClick={handleSubmit}
                                        disabled={!userAnswer.trim() || !explStartUnit || !explFirstUnit || !explFirstFactor.trim() || !explStepCount || !explReason}
                                        className="w-full bg-primary-orange text-white py-3 rounded-lg font-bold hover:bg-dark-orange disabled:bg-gray-300"
                                        aria-label="Senda inn svar"
                                    >
                                        Senda inn
                                    </button>
                                </div>
                            )}

                            {showFeedback && scores && (
                                <>
                                    <div className={`mb-6 p-6 rounded-lg ${
                                        scores.composite >= 0.75 ? 'bg-green-100' : 'bg-yellow-100'
                                    }`}>
                                        <h3 className="text-xl font-bold mb-4">
                                            {scores.composite >= 0.75 ? '‚úì Vel gert!' : '‚óã √û√∫ getur gert betur'}
                                        </h3>

                                        <div className="grid grid-cols-1 sm:grid-cols-2 gap-4 mb-4">
                                            <div>
                                                <p className="text-sm text-gray-600">Svar</p>
                                                <p className="text-2xl font-bold">{Math.round(scores.answer * 100)}%</p>
                                            </div>
                                            <div>
                                                <p className="text-sm text-gray-600">A√∞fer√∞</p>
                                                <p className="text-2xl font-bold">{Math.round(scores.method * 100)}%</p>
                                            </div>
                                            <div>
                                                <p className="text-sm text-gray-600">√ötsk√Ωring</p>
                                                <p className="text-2xl font-bold">{Math.round(scores.explanation * 100)}%</p>
                                            </div>
                                            <div>
                                                <p className="text-sm text-gray-600">Skilvirkni</p>
                                                <p className="text-2xl font-bold">{Math.round(scores.efficiency * 100)}%</p>
                                            </div>
                                        </div>

                                        <div className="border-t pt-4">
                                            <p className="text-lg font-bold">
                                                Heildareinkunn: {Math.round(scores.composite * 100)}%
                                            </p>
                                        </div>

                                        {problem.type === 'error_analysis' && (
                                            <div className="mt-4 p-3 bg-white rounded">
                                                <p className="text-sm font-semibold mb-1">√ötsk√Ωring √° villunni:</p>
                                                <p className="text-sm">{problem.errorExplanation}</p>
                                            </div>
                                        )}
                                    </div>

                                    <button
                                        onClick={handleContinue}
                                        className="w-full bg-primary-orange text-white py-3 rounded-lg font-bold hover:bg-dark-orange"
                                    >
                                        {currentProblemIndex < level3Challenges.length - 1 ? 'N√¶sta √°skorun' : 'Lj√∫ka'}
                                    </button>
                                </>
                            )}
                        </div>

                        {progress.achievements.length > 0 && (
                            <div className="mt-6 bg-white rounded-lg shadow-lg p-6">
                                <h3 className="text-xl font-bold mb-4">üèÜ Afrek</h3>
                                <div className="grid grid-cols-1 sm:grid-cols-2 gap-4">
                                    {progress.achievements.map((achievement) => (
                                        <div key={achievement.id} className="p-4 bg-gradient-to-r from-yellow-100 to-orange-100 rounded-lg">
                                            <p className="font-bold">{achievement.name}</p>
                                            <p className="text-sm text-gray-600">{achievement.description}</p>
                                        </div>
                                    ))}
                                </div>
                            </div>
                        )}
                    </div>
                </div>
            );
        }

        function Level2({ onComplete, onBack, initialProgress }) {
            const [currentProblemIndex, setCurrentProblemIndex] = useState(
                initialProgress?.problemsCompleted || 0
            );
            const [progress, setProgress] = useState(
                initialProgress || {
                    problemsCompleted: 0,
                    predictionsMade: 0,
                    predictionsCorrect: 0,
                    finalAnswersCorrect: 0,
                    mastered: false
                }
            );
            const [selectedFactors, setSelectedFactors] = useState([]);
            const [currentUnit, setCurrentUnit] = useState('');
            const [currentValue, setCurrentValue] = useState(0);
            const [showPredictionModal, setShowPredictionModal] = useState(false);
            const [pendingFactor, setPendingFactor] = useState(null);
            const [showFeedback, setShowFeedback] = useState(false);
            const [isCorrect, setIsCorrect] = useState(false);

            const problem = level2Problems[currentProblemIndex];

            useEffect(() => {
                if (problem) {
                    setCurrentUnit(problem.startUnit);
                    setCurrentValue(problem.startValue);
                    setSelectedFactors([]);
                    setShowFeedback(false);
                }
            }, [currentProblemIndex]);

            const getAvailableFactors = () => {
                // Filter factors based on scaffolding level
                if (problem.scaffoldingLevel === 3) {
                    // Only show factors that contain current unit
                    return conversionFactors.filter(f =>
                        f.units.includes(currentUnit) ||
                        (currentUnit.includes('/') && f.units.some(u => currentUnit.includes(u)))
                    );
                }
                return conversionFactors; // Show all for lower scaffolding
            };

            const handleFactorClick = (factor) => {
                setPendingFactor(factor);
                setShowPredictionModal(true);
            };

            const handlePrediction = (correct, resultingUnit) => {
                const newProgress = {
                    ...progress,
                    predictionsMade: progress.predictionsMade + 1,
                    predictionsCorrect: progress.predictionsCorrect + (correct ? 1 : 0)
                };
                setProgress(newProgress);

                if (correct) {
                    // Apply the factor
                    setSelectedFactors([...selectedFactors, pendingFactor]);
                    setCurrentUnit(resultingUnit);

                    // Calculate new value (simplified)
                    const factorNum = parseFloat(pendingFactor.num.split(' ')[0]);
                    const factorDen = parseFloat(pendingFactor.den.split(' ')[0]);
                    setCurrentValue(currentValue * factorNum / factorDen);
                }

                setPendingFactor(null);
            };

            const handleSubmit = () => {
                // Check if path matches correct path
                const selectedPath = selectedFactors.map(f => `${f.num} / ${f.den}`);
                const pathCorrect = problem.correctPath.every((step, idx) => selectedPath[idx] === step);
                const finalUnitCorrect = currentUnit === problem.targetUnit;

                const finalCorrect = pathCorrect && finalUnitCorrect;
                setIsCorrect(finalCorrect);
                setShowFeedback(true);

                const newProgress = {
                    ...progress,
                    finalAnswersCorrect: progress.finalAnswersCorrect + (finalCorrect ? 1 : 0)
                };
                setProgress(newProgress);

                // Save progress
                const saved = loadProgress() || { levelProgress: {} };
                saved.levelProgress.level2 = newProgress;
                saveProgress(saved);
            };

            const handleContinue = () => {
                const newProgress = {
                    ...progress,
                    problemsCompleted: progress.problemsCompleted + 1
                };

                // Check mastery after 15 problems
                if (newProgress.problemsCompleted >= 15) {
                    newProgress.mastered = checkLevel2Mastery(newProgress);
                }

                setProgress(newProgress);

                const saved = loadProgress() || { levelProgress: {} };
                saved.levelProgress.level2 = newProgress;
                saveProgress(saved);

                if (currentProblemIndex < level2Problems.length - 1) {
                    setCurrentProblemIndex(currentProblemIndex + 1);
                } else {
                    onComplete(newProgress);
                }
            };

            if (!problem) return null;

            const predictionAccuracy = progress.predictionsMade > 0
                ? Math.round((progress.predictionsCorrect / progress.predictionsMade) * 100)
                : 0;

            return (
                <div className="min-h-screen bg-gray-50 p-4">
                    <div className="max-w-4xl mx-auto">
                        <div className="mb-4 flex items-center justify-between">
                            <button
                                onClick={onBack}
                                className="text-gray-600 hover:text-gray-800 flex items-center gap-2"
                            >
                                ‚Üê Til baka
                            </button>
                            <div className="text-sm text-gray-600">
                                <span>Vandam√°l {progress.problemsCompleted + 1} / 15</span>
                                <span className="ml-4">Sp√°g√¶√∞i: {predictionAccuracy}%</span>
                            </div>
                        </div>

                        <div className="bg-white rounded-lg shadow-lg p-6">
                            <div className="mb-6 p-4 bg-blue-50 rounded-lg">
                                <p className="text-sm text-gray-600 mb-1">Samhengi:</p>
                                <p className="font-semibold">{problem.context}</p>
                            </div>

                            <div className="mb-6 p-6 bg-gray-50 rounded-lg text-center">
                                <p className="text-sm text-gray-600 mb-2">N√∫verandi gildi:</p>
                                <p className="text-3xl font-bold primary-orange">
                                    {currentValue.toFixed(3)} {currentUnit}
                                </p>
                                <p className="text-sm text-gray-600 mt-4">Markeiining: {problem.targetUnit}</p>
                            </div>

                            {selectedFactors.length > 0 && (
                                <div className="mb-6">
                                    <p className="text-sm font-semibold mb-2">Stu√∞lar nota√∞ir:</p>
                                    <div className="flex flex-wrap gap-2">
                                        {selectedFactors.map((factor, idx) => (
                                            <div key={idx} className="px-3 py-1 bg-green-100 text-green-800 rounded-lg text-sm font-mono">
                                                {factor.num} / {factor.den}
                                            </div>
                                        ))}
                                    </div>
                                </div>
                            )}

                            {!showFeedback && (
                                <>
                                    <div className="mb-6">
                                        <p className="font-semibold mb-3">Veldu umbreytingarstu√∞ul:</p>
                                        <div className="grid grid-cols-1 sm:grid-cols-2 gap-3">
                                            {getAvailableFactors().map((factor, idx) => (
                                                <button
                                                    key={idx}
                                                    onClick={() => handleFactorClick(factor)}
                                                    className="p-3 border-2 border-gray-300 rounded-lg hover:border-primary-orange hover:bg-orange-50 transition-all font-mono text-sm"
                                                >
                                                    {factor.num} / {factor.den}
                                                </button>
                                            ))}
                                        </div>
                                    </div>

                                    <button
                                        onClick={handleSubmit}
                                        disabled={selectedFactors.length === 0}
                                        className="w-full bg-primary-orange text-white py-3 rounded-lg font-bold hover:bg-dark-orange disabled:bg-gray-300"
                                    >
                                        Athuga svar
                                    </button>
                                </>
                            )}

                            {showFeedback && (
                                <>
                                    <div className={`mb-6 p-4 rounded-lg ${
                                        isCorrect ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'
                                    }`}>
                                        <p className="font-bold text-lg mb-2">
                                            {isCorrect ? '‚úì Fr√°b√¶rt! R√©tt svar!' : '‚úó Ekki alveg r√©tt'}
                                        </p>
                                        {!isCorrect && (
                                            <div className="text-sm mt-2">
                                                <p>R√©tt lei√∞:</p>
                                                <div className="mt-1 space-y-1">
                                                    {problem.correctPath.map((step, idx) => (
                                                        <div key={idx} className="font-mono">{step}</div>
                                                    ))}
                                                </div>
                                            </div>
                                        )}
                                    </div>

                                    <button
                                        onClick={handleContinue}
                                        className="w-full bg-primary-orange text-white py-3 rounded-lg font-bold hover:bg-dark-orange"
                                    >
                                        {currentProblemIndex < level2Problems.length - 1 ? 'N√¶sta vandam√°l' : 'Lj√∫ka'}
                                    </button>
                                </>
                            )}
                        </div>
                    </div>

                    {showPredictionModal && pendingFactor && (
                        <PredictionModal
                            factor={pendingFactor}
                            currentUnit={currentUnit}
                            onPredict={handlePrediction}
                            onClose={() => {
                                setShowPredictionModal(false);
                                setPendingFactor(null);
                            }}
                        />
                    )}
                </div>
            );
        }

        function Level1({ onComplete, onBack, initialProgress }) {
            const [phase, setPhase] = useState(initialProgress?.lessonsCompleted?.length === 3 ? 'questions' : 'lessons');
            const [currentLesson, setCurrentLesson] = useState(
                initialProgress?.lessonsCompleted?.length || 0
            );
            const [currentQuestion, setCurrentQuestion] = useState(
                initialProgress?.questionsAnswered || 0
            );
            const [progress, setProgress] = useState(
                initialProgress || {
                    lessonsCompleted: [],
                    questionsAnswered: 0,
                    questionsCorrect: 0,
                    explanationScores: [],
                    pointsEarned: 0,
                    hintsUsed: 0,
                    mastered: false
                }
            );

            const completeLesson = () => {
                const newProgress = {
                    ...progress,
                    lessonsCompleted: [...progress.lessonsCompleted, lessons[currentLesson].id]
                };
                setProgress(newProgress);

                if (currentLesson < lessons.length - 1) {
                    setCurrentLesson(currentLesson + 1);
                } else {
                    setPhase('questions');
                }

                // Save progress
                const saved = loadProgress() || { levelProgress: {} };
                saved.levelProgress.level1 = newProgress;
                saveProgress(saved);
            };

            const answerQuestion = (correct, explanationCorrect, hintUsed = false) => {
                const pointsEarned = (correct && !hintUsed) ? level1Questions[currentQuestion].points : 0;
                const newProgress = {
                    ...progress,
                    questionsAnswered: progress.questionsAnswered + 1,
                    questionsCorrect: progress.questionsCorrect + (correct ? 1 : 0),
                    explanationScores: [...progress.explanationScores, explanationCorrect ? 1 : 0],
                    pointsEarned: (progress.pointsEarned || 0) + pointsEarned,
                    hintsUsed: (progress.hintsUsed || 0) + (hintUsed ? 1 : 0)
                };

                setProgress(newProgress);

                // Save progress
                const saved = loadProgress() || { levelProgress: {} };
                saved.levelProgress.level1 = newProgress;

                // Check mastery
                if (newProgress.questionsAnswered === 10) {
                    newProgress.mastered = checkLevel1Mastery(newProgress);
                    saved.levelProgress.level1 = newProgress;
                }

                saveProgress(saved);

                if (currentQuestion < level1Questions.length - 1) {
                    setCurrentQuestion(currentQuestion + 1);
                } else {
                    onComplete(newProgress);
                }
            };

            if (phase === 'lessons') {
                return (
                    <LessonScreen
                        lesson={lessons[currentLesson]}
                        onComplete={completeLesson}
                    />
                );
            }

            return (
                <QuestionScreen
                    question={level1Questions[currentQuestion]}
                    questionNumber={currentQuestion + 1}
                    totalQuestions={level1Questions.length}
                    onAnswer={answerQuestion}
                    onBack={onBack}
                />
            );
        }

        function MainMenu({ onStartLevel1, onStartLevel2, onStartLevel3, onViewStats, onReset, progress }) {
            const level1Progress = progress?.levelProgress?.level1 || {
                questionsAnswered: 0,
                questionsCorrect: 0,
                pointsEarned: 0,
                hintsUsed: 0,
                mastered: false
            };

            const level2Progress = progress?.levelProgress?.level2 || {
                problemsCompleted: 0,
                predictionsMade: 0,
                predictionsCorrect: 0,
                finalAnswersCorrect: 0,
                mastered: false
            };

            const level3Progress = progress?.levelProgress?.level3 || {
                problemsCompleted: 0,
                compositeScores: [],
                totalSteps: 0,
                achievements: [],
                mastered: false
            };

            const level1Points = level1Progress.pointsEarned || 0;
            const level1MaxPoints = 80;
            const level1Percentage = level1Progress.questionsAnswered > 0
                ? Math.round((level1Points / level1MaxPoints) * 100)
                : 0;

            const level2Percentage = level2Progress.problemsCompleted > 0
                ? Math.round((level2Progress.finalAnswersCorrect / level2Progress.problemsCompleted) * 100)
                : 0;

            const level3Percentage = level3Progress.compositeScores.length > 0
                ? Math.round((level3Progress.compositeScores.reduce((a, b) => a + b, 0) / level3Progress.compositeScores.length) * 100)
                : 0;

            const level2Unlocked = level1Progress.mastered;
            const level3Unlocked = level2Progress.mastered;

            return (
                <div className="min-h-screen bg-gray-50 p-4">
                    <div className="max-w-4xl mx-auto">
                        <div className="text-center mb-8">
                            <h1 className="text-4xl font-bold primary-orange mb-2">üî¨ EININGAGREINING</h1>
                            <p className="text-xl text-gray-600">N√°mslei√∞in</p>
                        </div>

                        <div className="space-y-4">
                            {/* Level 1 */}
                            <div className="bg-white rounded-lg shadow-lg p-6">
                                <div className="flex items-center justify-between mb-4">
                                    <h2 className="text-2xl font-bold">Level 1: Skilningur</h2>
                                    <button
                                        onClick={onStartLevel1}
                                        className="bg-primary-orange text-white px-6 py-2 rounded-lg font-bold hover:bg-dark-orange"
                                    >
                                        {level1Progress.questionsAnswered > 0 ? 'Halda √°fram' : 'Byrja'}
                                    </button>
                                </div>
                                <div className="mb-2">
                                    <div className="w-full bg-gray-200 rounded-full h-4">
                                        <div
                                            className="bg-primary-orange h-4 rounded-full transition-all"
                                            style={{ width: `${level1Percentage}%` }}
                                        ></div>
                                    </div>
                                </div>
                                <p className="text-gray-600">
                                    <span className="font-semibold text-primary-orange">{level1Points}/{level1MaxPoints} stig</span> ¬∑ {level1Progress.questionsCorrect}/10 r√©tt
                                    {level1Progress.mastered && <span className="ml-2 text-green-600 font-bold">‚úì N√°msmarkmi√∞ n√°√∞!</span>}
                                </p>
                                <p className="text-sm text-gray-500 mt-2">
                                    √ûarfnast: 64+ stig (8/10 r√©tt me√∞ √∫tsk√Ωringum, √°n v√≠sbendinga)
                                </p>
                                {level1Progress.hintsUsed > 0 && (
                                    <p className="text-sm text-yellow-600 mt-1">
                                        üí° {level1Progress.hintsUsed} v√≠sbending{level1Progress.hintsUsed > 1 ? 'ar' : ''} nota√∞ar
                                    </p>
                                )}
                            </div>

                            {/* Level 2 */}
                            <div className={`bg-white rounded-lg shadow-lg p-6 ${!level2Unlocked ? 'opacity-50' : ''}`}>
                                <div className="flex items-center justify-between mb-4">
                                    <h2 className="text-2xl font-bold">Level 2: Beiting</h2>
                                    <button
                                        onClick={onStartLevel2}
                                        disabled={!level2Unlocked}
                                        className={`px-6 py-2 rounded-lg font-bold ${
                                            level2Unlocked
                                                ? 'bg-primary-orange text-white hover:bg-dark-orange'
                                                : 'bg-gray-300 text-gray-500 cursor-not-allowed'
                                        }`}
                                    >
                                        {!level2Unlocked ? 'üîí L√¶st' : level2Progress.problemsCompleted > 0 ? 'Halda √°fram' : 'Byrja'}
                                    </button>
                                </div>
                                {level2Unlocked ? (
                                    <>
                                        <div className="mb-2">
                                            <div className="w-full bg-gray-200 rounded-full h-4">
                                                <div
                                                    className="bg-primary-orange h-4 rounded-full transition-all"
                                                    style={{ width: `${(level2Progress.problemsCompleted / 15) * 100}%` }}
                                                ></div>
                                            </div>
                                        </div>
                                        <p className="text-gray-600">
                                            {level2Progress.problemsCompleted}/15 vandam√°l
                                            {level2Progress.mastered && <span className="ml-2 text-green-600 font-bold">‚úì N√°msmarkmi√∞ n√°√∞!</span>}
                                        </p>
                                        <p className="text-sm text-gray-500 mt-2">
                                            √ûarfnast: 15 vandam√°l, 70%+ sp√°g√¶√∞i, 80%+ r√©tt sv√∂r
                                        </p>
                                    </>
                                ) : (
                                    <p className="text-gray-600">Kl√°ra√∞u Level 1 til a√∞ opna</p>
                                )}
                            </div>

                            {/* Level 3 */}
                            <div className={`bg-white rounded-lg shadow-lg p-6 ${!level3Unlocked ? 'opacity-50' : ''}`}>
                                <div className="flex items-center justify-between mb-4">
                                    <h2 className="text-2xl font-bold">Level 3: Greining</h2>
                                    <button
                                        onClick={onStartLevel3}
                                        disabled={!level3Unlocked}
                                        className={`px-6 py-2 rounded-lg font-bold ${
                                            level3Unlocked
                                                ? 'bg-primary-orange text-white hover:bg-dark-orange'
                                                : 'bg-gray-300 text-gray-500 cursor-not-allowed'
                                        }`}
                                    >
                                        {!level3Unlocked ? 'üîí L√¶st' : level3Progress.problemsCompleted > 0 ? 'Halda √°fram' : 'Byrja'}
                                    </button>
                                </div>
                                {level3Unlocked ? (
                                    <>
                                        <div className="mb-2">
                                            <div className="w-full bg-gray-200 rounded-full h-4">
                                                <div
                                                    className="bg-primary-orange h-4 rounded-full transition-all"
                                                    style={{ width: `${(level3Progress.problemsCompleted / 10) * 100}%` }}
                                                ></div>
                                            </div>
                                        </div>
                                        <p className="text-gray-600">
                                            {level3Progress.problemsCompleted}/10 √°skoranir
                                            {level3Progress.mastered && <span className="ml-2 text-green-600 font-bold">‚úì N√°msmarkmi√∞ n√°√∞!</span>}
                                        </p>
                                        <p className="text-sm text-gray-500 mt-2">
                                            √ûarfnast: 10 √°skoranir, 75%+ heildareinkunn
                                        </p>
                                        {level3Progress.achievements.length > 0 && (
                                            <div className="mt-3 flex gap-2 flex-wrap">
                                                {level3Progress.achievements.map(a => (
                                                    <span key={a.id} className="text-2xl" title={a.description}>
                                                        {a.id === 'gold' && 'ü•á'}
                                                        {a.id === 'silver' && 'ü•à'}
                                                        {a.id === 'bronze' && 'ü•â'}
                                                        {a.id === 'efficiency' && '‚ö°'}
                                                        {a.id === 'explainer' && 'üìù'}
                                                    </span>
                                                ))}
                                            </div>
                                        )}
                                    </>
                                ) : (
                                    <p className="text-gray-600">Kl√°ra√∞u Level 2 til a√∞ opna</p>
                                )}
                            </div>
                        </div>

                        <div className="mt-8 flex gap-4 justify-center">
                            <button
                                onClick={onViewStats}
                                className="border-2 border-gray-300 px-6 py-2 rounded-lg hover:border-gray-400"
                            >
                                Sj√° t√∂lfr√¶√∞i
                            </button>
                            <button
                                onClick={onReset}
                                className="border-2 border-red-300 text-red-600 px-6 py-2 rounded-lg hover:border-red-400"
                            >
                                Byrja aftur
                            </button>
                        </div>
                    </div>
                </div>
            );
        }

        function StatsScreen({ progress, onBack }) {
            const level1Progress = progress?.levelProgress?.level1 || {
                questionsAnswered: 0,
                questionsCorrect: 0,
                explanationScores: [],
                pointsEarned: 0,
                hintsUsed: 0
            };

            const level2Progress = progress?.levelProgress?.level2 || {
                problemsCompleted: 0,
                predictionsMade: 0,
                predictionsCorrect: 0,
                finalAnswersCorrect: 0,
                mastered: false
            };

            const level3Progress = progress?.levelProgress?.level3 || {
                problemsCompleted: 0,
                compositeScores: [],
                totalSteps: 0,
                achievements: []
            };

            const explanationAvg = level1Progress.explanationScores.length > 0
                ? Math.round((level1Progress.explanationScores.reduce((a, b) => a + b, 0) / level1Progress.explanationScores.length) * 100)
                : 0;

            const predictionAccuracy = level2Progress.predictionsMade > 0
                ? Math.round((level2Progress.predictionsCorrect / level2Progress.predictionsMade) * 100)
                : 0;

            const answerAccuracy = level2Progress.problemsCompleted > 0
                ? Math.round((level2Progress.finalAnswersCorrect / level2Progress.problemsCompleted) * 100)
                : 0;

            const level3Avg = level3Progress.compositeScores.length > 0
                ? Math.round((level3Progress.compositeScores.reduce((a, b) => a + b, 0) / level3Progress.compositeScores.length) * 100)
                : 0;

            const exportToJSON = () => {
                const exportData = {
                    timestamp: new Date().toISOString(),
                    studentId: '', // Teacher can add this later
                    progress: progress
                };
                const blob = new Blob([JSON.stringify(exportData, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `einingagreining-progress-${new Date().toISOString().split('T')[0]}.json`;
                a.click();
                URL.revokeObjectURL(url);
            };

            const exportToCSV = () => {
                const csv = [
                    ['Dagsetning', new Date().toISOString()],
                    [''],
                    ['Level 1: Skilningur'],
                    ['Spurningar svara√∞ar', level1Progress.questionsAnswered],
                    ['R√©tt sv√∂r', level1Progress.questionsCorrect],
                    ['Stig unnin', level1Progress.pointsEarned || 0],
                    ['V√≠sbendingar nota√∞ar', level1Progress.hintsUsed || 0],
                    ['√ötsk√Ωringar (%)', explanationAvg],
                    ['N√°msmarkmi√∞ n√°√∞', level1Progress.mastered ? 'J√°' : 'Nei'],
                    [''],
                    ['Level 2: Beiting'],
                    ['Vandam√°l leyst', level2Progress.problemsCompleted],
                    ['Sp√°r ger√∞ar', level2Progress.predictionsMade],
                    ['Sp√°r r√©ttar', level2Progress.predictionsCorrect],
                    ['Sp√°g√¶√∞i (%)', predictionAccuracy],
                    ['R√©tt sv√∂r', level2Progress.finalAnswersCorrect],
                    ['N√°kv√¶mni (%)', answerAccuracy],
                    ['N√°msmarkmi√∞ n√°√∞', level2Progress.mastered ? 'J√°' : 'Nei'],
                    [''],
                    ['Level 3: Greining'],
                    ['Vandam√°l leyst', level3Progress.problemsCompleted],
                    ['Me√∞aleinkunn (%)', level3Avg],
                    ['Heildarskref', level3Progress.totalSteps],
                    ['Ver√∞laun', level3Progress.achievements.map(a => a.name).join(', ')]
                ].map(row => row.join(',')).join('\n');

                const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `einingagreining-progress-${new Date().toISOString().split('T')[0]}.csv`;
                a.click();
                URL.revokeObjectURL(url);
            };

            return (
                <div className="min-h-screen bg-gray-50 p-4">
                    <div className="max-w-4xl mx-auto">
                        <button
                            onClick={onBack}
                            className="mb-4 text-gray-600 hover:text-gray-800 flex items-center gap-2"
                            aria-label="Til baka"
                        >
                            ‚Üê Til baka
                        </button>

                        <div className="bg-white rounded-lg shadow-lg p-6">
                            <div className="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-6 gap-4">
                                <h2 className="text-2xl font-bold">T√∂lfr√¶√∞i</h2>
                                <div className="flex gap-2 flex-wrap">
                                    <button
                                        onClick={exportToJSON}
                                        className="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg font-semibold text-sm flex items-center gap-2"
                                        aria-label="S√¶kja sem JSON"
                                    >
                                        üìÑ S√¶kja JSON
                                    </button>
                                    <button
                                        onClick={exportToCSV}
                                        className="bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded-lg font-semibold text-sm flex items-center gap-2"
                                        aria-label="S√¶kja sem CSV"
                                    >
                                        üìä S√¶kja CSV
                                    </button>
                                </div>
                            </div>

                            <div className="space-y-6">
                                <div>
                                    <h3 className="text-xl font-semibold mb-3 primary-orange">Level 1: Skilningur</h3>
                                    <div className="grid grid-cols-1 sm:grid-cols-2 gap-4">
                                        <div className="p-4 bg-gray-50 rounded">
                                            <p className="text-sm text-gray-600">Spurningar svara√∞ar</p>
                                            <p className="text-2xl font-bold">{level1Progress.questionsAnswered}/10</p>
                                        </div>
                                        <div className="p-4 bg-gray-50 rounded">
                                            <p className="text-sm text-gray-600">R√©tt sv√∂r</p>
                                            <p className="text-2xl font-bold">{level1Progress.questionsCorrect}/10</p>
                                        </div>
                                        <div className="p-4 bg-gray-50 rounded">
                                            <p className="text-sm text-gray-600">√ötsk√Ωringar</p>
                                            <p className="text-2xl font-bold">{explanationAvg}%</p>
                                        </div>
                                        <div className="p-4 bg-gray-50 rounded">
                                            <p className="text-sm text-gray-600">Sta√∞a</p>
                                            <p className="text-2xl font-bold">
                                                {level1Progress.mastered ? '‚úì N√°√∞' : '‚ãØ √ç vinnslu'}
                                            </p>
                                        </div>
                                    </div>
                                </div>

                                <div className="border-t pt-6">
                                    <h3 className="text-lg font-semibold mb-2">N√°msmarkmi√∞ Level 1</h3>
                                    <ul className="space-y-2 text-sm">
                                        <li className={level1Progress.questionsCorrect >= 8 ? 'text-green-600' : 'text-gray-600'}>
                                            {level1Progress.questionsCorrect >= 8 ? '‚úì' : '‚óã'} 8/10 r√©tt sv√∂r
                                        </li>
                                        <li className={explanationAvg >= 70 ? 'text-green-600' : 'text-gray-600'}>
                                            {explanationAvg >= 70 ? '‚úì' : '‚óã'} 70%+ √° √∫tsk√Ωringum
                                        </li>
                                    </ul>
                                </div>

                                {level1Progress.mastered && (
                                    <>
                                        <div className="border-t pt-6">
                                            <h3 className="text-xl font-semibold mb-3 primary-orange">Level 2: Beiting</h3>
                                            <div className="grid grid-cols-1 sm:grid-cols-2 gap-4">
                                                <div className="p-4 bg-gray-50 rounded">
                                                    <p className="text-sm text-gray-600">Vandam√°l leyst</p>
                                                    <p className="text-2xl font-bold">{level2Progress.problemsCompleted}/15</p>
                                                </div>
                                                <div className="p-4 bg-gray-50 rounded">
                                                    <p className="text-sm text-gray-600">Sp√°g√¶√∞i</p>
                                                    <p className="text-2xl font-bold">{predictionAccuracy}%</p>
                                                </div>
                                                <div className="p-4 bg-gray-50 rounded">
                                                    <p className="text-sm text-gray-600">R√©tt sv√∂r</p>
                                                    <p className="text-2xl font-bold">{answerAccuracy}%</p>
                                                </div>
                                                <div className="p-4 bg-gray-50 rounded">
                                                    <p className="text-sm text-gray-600">Sta√∞a</p>
                                                    <p className="text-2xl font-bold">
                                                        {level2Progress.mastered ? '‚úì N√°√∞' : '‚ãØ √ç vinnslu'}
                                                    </p>
                                                </div>
                                            </div>
                                        </div>

                                        <div className="border-t pt-6">
                                            <h3 className="text-lg font-semibold mb-2">N√°msmarkmi√∞ Level 2</h3>
                                            <ul className="space-y-2 text-sm">
                                                <li className={level2Progress.problemsCompleted >= 15 ? 'text-green-600' : 'text-gray-600'}>
                                                    {level2Progress.problemsCompleted >= 15 ? '‚úì' : '‚óã'} 15 vandam√°l loki√∞
                                                </li>
                                                <li className={predictionAccuracy >= 70 ? 'text-green-600' : 'text-gray-600'}>
                                                    {predictionAccuracy >= 70 ? '‚úì' : '‚óã'} 70%+ sp√°g√¶√∞i
                                                </li>
                                                <li className={answerAccuracy >= 80 ? 'text-green-600' : 'text-gray-600'}>
                                                    {answerAccuracy >= 80 ? '‚úì' : '‚óã'} 80%+ r√©tt sv√∂r
                                                </li>
                                            </ul>
                                        </div>
                                    </>
                                )}

                                {level2Progress.mastered && progress?.levelProgress?.level3 && (
                                    <>
                                        <div className="border-t pt-6">
                                            <h3 className="text-xl font-semibold mb-3 primary-orange">Level 3: Greining</h3>
                                            <div className="grid grid-cols-1 sm:grid-cols-2 gap-4">
                                                <div className="p-4 bg-gray-50 rounded">
                                                    <p className="text-sm text-gray-600">√Åskoranir kl√°ra√∞ar</p>
                                                    <p className="text-2xl font-bold">{progress.levelProgress.level3.problemsCompleted}/10</p>
                                                </div>
                                                <div className="p-4 bg-gray-50 rounded">
                                                    <p className="text-sm text-gray-600">Me√∞aleinkunn</p>
                                                    <p className="text-2xl font-bold">
                                                        {progress.levelProgress.level3.compositeScores.length > 0
                                                            ? Math.round((progress.levelProgress.level3.compositeScores.reduce((a, b) => a + b, 0) / progress.levelProgress.level3.compositeScores.length) * 100)
                                                            : 0}%
                                                    </p>
                                                </div>
                                                <div className="p-4 bg-gray-50 rounded">
                                                    <p className="text-sm text-gray-600">Afrek</p>
                                                    <p className="text-2xl font-bold">{progress.levelProgress.level3.achievements.length}</p>
                                                </div>
                                                <div className="p-4 bg-gray-50 rounded">
                                                    <p className="text-sm text-gray-600">Sta√∞a</p>
                                                    <p className="text-2xl font-bold">
                                                        {progress.levelProgress.level3.mastered ? '‚úì N√°√∞' : '‚ãØ √ç vinnslu'}
                                                    </p>
                                                </div>
                                            </div>

                                            {progress.levelProgress.level3.achievements.length > 0 && (
                                                <div className="mt-4 p-4 bg-gradient-to-r from-yellow-50 to-orange-50 rounded-lg">
                                                    <p className="font-semibold mb-2">Afrek:</p>
                                                    <div className="flex gap-3 flex-wrap">
                                                        {progress.levelProgress.level3.achievements.map(a => (
                                                            <div key={a.id} className="flex items-center gap-2 text-sm">
                                                                <span className="text-2xl">
                                                                    {a.id === 'gold' && 'ü•á'}
                                                                    {a.id === 'silver' && 'ü•à'}
                                                                    {a.id === 'bronze' && 'ü•â'}
                                                                    {a.id === 'efficiency' && '‚ö°'}
                                                                    {a.id === 'explainer' && 'üìù'}
                                                                </span>
                                                                <span>{a.name}</span>
                                                            </div>
                                                        ))}
                                                    </div>
                                                </div>
                                            )}
                                        </div>

                                        <div className="border-t pt-6">
                                            <h3 className="text-lg font-semibold mb-2">N√°msmarkmi√∞ Level 3</h3>
                                            <ul className="space-y-2 text-sm">
                                                <li className={progress.levelProgress.level3.problemsCompleted >= 10 ? 'text-green-600' : 'text-gray-600'}>
                                                    {progress.levelProgress.level3.problemsCompleted >= 10 ? '‚úì' : '‚óã'} 10 √°skoranir kl√°ra√∞ar
                                                </li>
                                                <li className={progress.levelProgress.level3.compositeScores.length > 0 && (progress.levelProgress.level3.compositeScores.reduce((a, b) => a + b, 0) / progress.levelProgress.level3.compositeScores.length) >= 0.75 ? 'text-green-600' : 'text-gray-600'}>
                                                    {progress.levelProgress.level3.compositeScores.length > 0 && (progress.levelProgress.level3.compositeScores.reduce((a, b) => a + b, 0) / progress.levelProgress.level3.compositeScores.length) >= 0.75 ? '‚úì' : '‚óã'} 75%+ heildareinkunn
                                                </li>
                                            </ul>
                                        </div>
                                    </>
                                )}
                            </div>
                        </div>
                    </div>
                </div>
            );
        }

        function App() {
            const [gameState, setGameState] = useState({
                screen: 'menu',
                progress: loadProgress() || {
                    currentLevel: 1,
                    levelProgress: {
                        level1: {
                            lessonsCompleted: [],
                            questionsAnswered: 0,
                            questionsCorrect: 0,
                            explanationScores: [],
                            mastered: false
                        },
                        level2: {
                            problemsCompleted: 0,
                            predictionsMade: 0,
                            predictionsCorrect: 0,
                            finalAnswersCorrect: 0,
                            mastered: false
                        },
                        level3: {
                            problemsCompleted: 0,
                            compositeScores: [],
                            totalSteps: 0,
                            achievements: [],
                            mastered: false
                        }
                    }
                }
            });

            const handleStartLevel1 = () => {
                setGameState({ ...gameState, screen: 'level1' });
            };

            const handleStartLevel2 = () => {
                setGameState({ ...gameState, screen: 'level2' });
            };

            const handleStartLevel3 = () => {
                setGameState({ ...gameState, screen: 'level3' });
            };

            const handleLevel1Complete = (level1Progress) => {
                const newProgress = { ...gameState.progress };
                newProgress.levelProgress.level1 = level1Progress;
                saveProgress(newProgress);
                setGameState({ ...gameState, progress: newProgress, screen: 'menu' });
            };

            const handleLevel2Complete = (level2Progress) => {
                const newProgress = { ...gameState.progress };
                newProgress.levelProgress.level2 = level2Progress;
                saveProgress(newProgress);
                setGameState({ ...gameState, progress: newProgress, screen: 'menu' });
            };

            const handleLevel3Complete = (level3Progress) => {
                const newProgress = { ...gameState.progress };
                newProgress.levelProgress.level3 = level3Progress;
                saveProgress(newProgress);
                setGameState({ ...gameState, progress: newProgress, screen: 'menu' });
            };

            const handleViewStats = () => {
                setGameState({ ...gameState, screen: 'stats' });
            };

            const handleReset = () => {
                if (confirm('Ertu viss um a√∞ √æ√∫ viljir ey√∞a √∂llum framf√∂rum?')) {
                    localStorage.removeItem('dimensionalAnalysisProgress');
                    setGameState({
                        screen: 'menu',
                        progress: {
                            currentLevel: 1,
                            levelProgress: {
                                level1: {
                                    lessonsCompleted: [],
                                    questionsAnswered: 0,
                                    questionsCorrect: 0,
                                    explanationScores: [],
                                    mastered: false
                                },
                                level2: {
                                    problemsCompleted: 0,
                                    predictionsMade: 0,
                                    predictionsCorrect: 0,
                                    finalAnswersCorrect: 0,
                                    mastered: false
                                },
                                level3: {
                                    problemsCompleted: 0,
                                    compositeScores: [],
                                    totalSteps: 0,
                                    achievements: [],
                                    mastered: false
                                }
                            }
                        }
                    });
                }
            };

            const handleBack = () => {
                setGameState({ ...gameState, screen: 'menu' });
            };

            if (gameState.screen === 'level1') {
                return (
                    <Level1
                        onComplete={handleLevel1Complete}
                        onBack={handleBack}
                        initialProgress={gameState.progress.levelProgress.level1}
                    />
                );
            }

            if (gameState.screen === 'level2') {
                return (
                    <Level2
                        onComplete={handleLevel2Complete}
                        onBack={handleBack}
                        initialProgress={gameState.progress.levelProgress.level2}
                    />
                );
            }

            if (gameState.screen === 'level3') {
                return (
                    <Level3
                        onComplete={handleLevel3Complete}
                        onBack={handleBack}
                        initialProgress={gameState.progress.levelProgress.level3}
                    />
                );
            }

            if (gameState.screen === 'stats') {
                return (
                    <StatsScreen
                        progress={gameState.progress}
                        onBack={handleBack}
                    />
                );
            }

            return (
                <MainMenu
                    onStartLevel1={handleStartLevel1}
                    onStartLevel2={handleStartLevel2}
                    onStartLevel3={handleStartLevel3}
                    onViewStats={handleViewStats}
                    onReset={handleReset}
                    progress={gameState.progress}
                />
            );
        }

        // Render the app
        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
